import{j as e}from"./ui-DXEsCjYO.js";import{r as l}from"./vendor-B6OAZll8.js";import{c as E,b as _}from"./state-BMzes8HB.js";import{u as P}from"./audio-B1K76-a3.js";import{d as F,c as y,f as T,s as $,b as z,B as A}from"./index-CdJ0LLsE.js";import{f as G,m as D,i as K,n as O,o as X,p as J,q as Q,r as Y,s as Z,t as ee,u as se,v as te}from"./icons-Bi8i6cou.js";import{u as ae}from"./useConnection-h2CLINrd.js";import{t as I}from"./utils-E4Pq5uL6.js";import"./sdk-9Bd1H_oq.js";const ne=(s=100)=>{const t=[];for(let a=0;a<s;a++){const n=Math.sin(a/8)*.4+.5,i=Math.random()*.3;t.push(Math.max(.1,Math.min(1,n+i)))}return t};function re({isUser:s=!1,isRecording:t=!1,audioUrl:a,durationMs:n,messageId:i}){const m=l.useRef(null),g=l.useRef(null),[v,j]=l.useState(!!a),k=E(F),N=i?k.messages.find(d=>d.id===i):null,f=(N==null?void 0:N.amplitudeHistory)||[];if(l.useEffect(()=>{if(m.current){if(a&&!t){const d=P.create({container:m.current,waveColor:s?"rgba(0, 0, 0, 0.5)":"rgba(255, 255, 255, 0.5)",progressColor:s?"#000000":"#ffffff",height:60,barWidth:2,barGap:1,barRadius:2,cursorWidth:0,normalize:!0,url:a});return d.on("ready",()=>{j(!1)}),d.on("error",p=>{console.error("WaveSurfer error:",p),j(!1)}),g.current=d,()=>{d.destroy()}}else if(!t){const d=ne(100),p=P.create({container:m.current,waveColor:s?"rgba(0, 0, 0, 0.6)":"rgba(255, 255, 255, 0.6)",progressColor:s?"#000000":"#ffffff",height:60,barWidth:2,barGap:1,barRadius:2,cursorWidth:0,normalize:!0});return p.load("",[d],n?n/1e3:5),g.current=p,j(!1),()=>{p.destroy()}}}},[a,t,s,n,f,i]),f.length>0){const b=f.length>0?f.slice(-50).map(o=>{const r=(o==null?void 0:o.normalizedPeak)||0;return Math.max(6,r*52+6)}):[];return e.jsx("div",{className:"flex items-center justify-center gap-0.5 h-16 my-2 px-4 rounded-lg bg-opacity-10 w-full max-w-full overflow-hidden",children:Array.from({length:50}).map((x,o)=>e.jsx("div",{className:`w-1 rounded-full ${s?"bg-black/80":"bg-white/80"}`,style:{height:`${b[o]||6}px`}},o))})}if(t){const b=f.length>0?f.slice(-50).map(o=>{const r=(o==null?void 0:o.normalizedPeak)||0;return Math.max(6,r*52+6)}):Array.from({length:50},()=>Math.random()*52+6);return e.jsx("div",{className:"flex items-center justify-center gap-0.5 h-16 my-2 px-4 rounded-lg bg-opacity-10 w-full max-w-full overflow-hidden",children:Array.from({length:50}).map((x,o)=>e.jsx("div",{className:`w-1 rounded-full transition-all duration-100 ${s?"bg-black/80":"bg-white/80"}`,style:{height:`${b[o]}px`,animationDelay:`${o*30}ms`,animationDuration:`${800+Math.random()*400}ms`}},o))})}return a&&!f.length?e.jsxs("div",{className:"my-2 px-2 min-w-[300px]",children:[v&&e.jsx("div",{className:"flex items-center justify-center h-16",children:e.jsx("span",{className:"text-xs text-gray-500",children:"Loading waveform..."})}),e.jsx("div",{ref:m,className:`${v?"hidden":""}`})]}):e.jsx("div",{className:"flex items-center justify-center h-16 my-2",children:e.jsx("span",{className:"text-xs text-gray-400",children:"No waveform data"})})}function w(s){return function(a){const{message:n,showTime:i=!0,...m}=a;return e.jsxs("div",{className:"flex flex-col",style:{maxWidth:"100%"},children:[e.jsx(s,{...m,message:n,showTime:i}),e.jsx("span",{className:"timestamp",style:{alignSelf:n.role==="user"?"flex-end":"flex-start"},children:new Date(n.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})}}function ce({message:s,showTime:t,className:a}){return e.jsx("div",{className:y("SttStreamRequestMessage",a),children:e.jsxs("div",{className:"voice-message-header",children:[e.jsx("div",{className:"voice-message-info",children:e.jsxs("div",{className:"voice-message-icon-text",children:[e.jsx(G,{className:"voice-message-icon text-black"}),e.jsx("span",{className:"voice-message-label text-black",children:"STT Stream"}),t&&e.jsx("span",{className:"voice-message-time text-black",children:T(s.durationMs)})]})}),e.jsx("div",{className:"waveform-container",children:e.jsx(re,{isUser:!0,isRecording:s.isRecording||!1,durationMs:s.durationMs,messageId:s.id})}),s.status==="error"&&s.error&&e.jsx("div",{className:"voice-message-error",children:e.jsxs("span",{className:"voice-message-error-text text-red-600",children:["Error: ",s.error]})})]})})}const ie=w(ce);function oe({message:s,showTime:t,className:a}){return e.jsx("div",{className:y("SttFileRequestMessage",a),children:e.jsxs("div",{className:"file-message-indicator",children:[s.status==="processing"?e.jsx(D,{className:"file-message-icon animate-spin text-black"}):e.jsx(K,{className:"file-message-icon text-black"}),e.jsx("span",{className:"file-message-text text-black",children:s.status==="processing"?"Processing file...":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"voice-message-label text-black",children:"STT File"})," ",e.jsx("span",{className:"voice-message-time text-black",children:s.fileName||"upload"}),t&&e.jsx("span",{className:"voice-message-time text-black",children:T(s.durationMs)})]})})]})})}const le=w(oe);function de({message:s,showTime:t,className:a}){return e.jsxs("div",{className:y("TtsRequestMessage",a,"tts-request-message"),children:[e.jsx("div",{className:"voice-message-header",children:e.jsx("div",{className:"voice-message-info",children:e.jsxs("div",{className:"voice-message-icon-text",children:[e.jsx(O,{className:"voice-tts-icon text-black"}),e.jsx("span",{className:"voice-message-label text-black",children:"TTS"}),e.jsx(X,{className:"voice-message-icon text-black"}),e.jsx("span",{className:"voice-message-time text-black",children:s.voice||"tara"}),t&&e.jsx("span",{className:"voice-message-time text-black",children:T(s.durationMs)})]})})}),s.content&&e.jsx("p",{className:"message-content-request",children:s.content})]})}const ue=w(de);function me({message:s,showTime:t,className:a}){return e.jsxs("div",{className:y("TranscriptResponseMessage",a),children:[e.jsx("div",{className:"transcript-message-header",children:e.jsx("div",{className:"transcript-message-info",children:e.jsxs("div",{className:"transcript-message-icon-text",children:[e.jsx(J,{className:"transcript-message-icon"}),e.jsx("span",{className:"transcript-message-label text-black",children:"Transcription"}),t&&e.jsx("span",{className:"voice-message-time text-black",children:T(s.durationMs)})]})})}),s.content&&e.jsx("p",{className:"message-content-response",children:s.content})]})}const fe=w(me);function he({message:s,showTime:t,className:a}){const n=i=>JSON.stringify(i,null,2).replace(/(".*?")(?=\s*:)/g,'<span class="json-key">$1</span>').replace(/:\s*(".*?")/g,': <span class="json-string">$1</span>').replace(/:\s*(\d+(?:\.\d+)?)/g,': <span class="json-number">$1</span>').replace(/:\s*(true|false)/g,': <span class="json-boolean">$1</span>').replace(/:\s*(null)/g,': <span class="json-null">$1</span>');return e.jsxs("div",{className:y("StructuredResponseMessage","structured-response-message",a),children:[e.jsx("div",{className:"transcript-message-header",children:e.jsx("div",{className:"transcript-message-info",children:e.jsxs("div",{className:"transcript-message-icon-text",children:[e.jsx(Q,{className:"transcript-message-icon"}),e.jsx("span",{className:"transcript-message-label",children:"Structured Data"})]})})}),s.structuredData&&e.jsx("div",{className:"structured-data-container",children:e.jsx("pre",{className:"structured-data-json",dangerouslySetInnerHTML:{__html:n(s.structuredData)}})})]})}const pe=w(he);function xe(s){const t=s.environment;return{apiKey:s[t].connection.apiKey,baseUrl:s[t].connection.baseUrl,authBaseUrl:s[t].connection.authBaseUrl,workflowId:s[t].connection.workflowId,environment:t,stt:s[t].stt,tts:s[t].tts}}function ge(){const s=E($),{getClient:t,isConnected:a,sessionId:n}=ae(),[i,m]=l.useState(!1),g=l.useCallback(async(v,j)=>{try{m(!0);const k=await t(),N=xe(s),f=await k.tts.synthesize({text:v,voice:j||N.tts.voice,language:N.tts.language}),d=[],p=f.getReader();try{for(;;){const{done:r,value:S}=await p.read();if(r)break;d.push(S)}}finally{p.releaseLock()}const b=d.reduce((r,S)=>r+S.length,0),x=new Uint8Array(b);let o=0;for(const r of d)x.set(r,o),o+=r.length;return new Blob([x],{type:"audio/mpeg"})}finally{m(!1)}},[t,s]);return{isGenerating:i,isConnected:a,sessionId:n,generateTTS:g}}function ve(s){const t=s.environment;return{apiKey:s[t].connection.apiKey,baseUrl:s[t].connection.baseUrl,authBaseUrl:s[t].connection.authBaseUrl,workflowId:s[t].connection.workflowId,environment:t,stt:s[t].stt,tts:s[t].tts}}function je({messageId:s,text:t,className:a=""}){const[n,i]=_(z),[m]=_($),g=ve(m),[v,j]=l.useState(null),[k,N]=l.useState(!1),[f,d]=l.useState(0),[p,b]=l.useState(0),[x,o]=l.useState(1),r=l.useRef(null),S=l.useRef(null),{generateTTS:W,isGenerating:B}=ge(),M=n.playingMessageId===s;l.useEffect(()=>()=>{r.current&&(r.current.pause(),r.current=null)},[]),l.useEffect(()=>{const c=r.current;if(!c)return;const u=()=>b(c.currentTime),h=()=>d(c.duration);return c.addEventListener("timeupdate",u),c.addEventListener("loadedmetadata",h),()=>{c.removeEventListener("timeupdate",u),c.removeEventListener("loadedmetadata",h)}},[M]);const q=async()=>{if(M){r.current&&r.current.pause(),i(c=>({...c,playingMessageId:void 0}));return}n.playingMessageId&&r.current&&r.current.pause();try{if(N(!0),!v){if(!g.apiKey){I.error("Please configure your API key first");return}const h=await W(t);j(h)}const c=URL.createObjectURL(v||new Blob),u=new Audio(c);r.current=u,u.volume=x,u.addEventListener("ended",()=>{i(h=>({...h,playingMessageId:void 0})),b(0),URL.revokeObjectURL(c)}),u.addEventListener("error",h=>{console.error("Audio playback error:",h),I.error("Audio playback failed"),i(R=>({...R,playingMessageId:void 0})),URL.revokeObjectURL(c)}),i(h=>({...h,playingMessageId:s})),await u.play()}catch(c){console.error("TTS Error:",c),I.error("Text-to-speech failed")}finally{N(!1)}},U=c=>{if(!r.current||!S.current)return;const u=S.current.getBoundingClientRect(),h=c.clientX-u.left,R=u.width,L=h/R*f;r.current.currentTime=L,b(L)},V=c=>{const u=parseFloat(c.target.value);o(u),r.current&&(r.current.volume=u)},C=c=>{if(isNaN(c))return"0:00";const u=Math.floor(c/60),h=Math.floor(c%60);return`${u}:${h.toString().padStart(2,"0")}`},H=f>0?p/f*100:0;return e.jsx("div",{className:y("TTSPlaybackWidget",a),children:e.jsxs("div",{className:"tts-playback-controls",children:[e.jsxs("div",{className:"tts-top-row",children:[e.jsx(A,{variant:"ghost",size:"sm",onClick:q,disabled:B||k,className:"tts-play-button",children:B||k?e.jsx(D,{className:"h-4 w-4 animate-spin"}):M?e.jsx(Y,{className:"h-4 w-4"}):e.jsx(Z,{className:"h-4 w-4"})}),e.jsxs("div",{className:"tts-progress-container",children:[e.jsx("div",{className:"tts-progress-wrapper",children:e.jsx("div",{className:"tts-progress-track",ref:S,onClick:U,children:e.jsx("div",{className:"tts-progress-fill",style:{width:`${H}%`}})})}),e.jsxs("div",{className:"tts-time-display",children:[e.jsx("span",{className:"tts-current-time",children:C(p)}),e.jsx("span",{className:"tts-duration",children:C(f)})]})]})]}),e.jsxs("div",{className:"tts-volume-control",children:[e.jsx(A,{variant:"ghost",size:"sm",onClick:()=>{const c=x>0?0:1;o(c),r.current&&(r.current.volume=c)},className:"tts-volume-button",children:x>0?e.jsx(ee,{className:"h-4 w-4"}):e.jsx(se,{className:"h-4 w-4"})}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:x,onChange:V,className:"tts-volume-slider"})]})]})})}function Ne({message:s,showTime:t,className:a}){return e.jsxs("div",{className:y("VoiceResponseMessage",a),children:[e.jsx("div",{className:"transcript-message-header",children:e.jsx("div",{className:"transcript-message-info",children:e.jsxs("div",{className:"transcript-message-icon-text",children:[e.jsx(te,{className:"transcript-message-icon"}),e.jsx("span",{className:"transcript-message-label text-black",children:"TTS Playback"}),t&&s.durationMs&&e.jsx("span",{className:"voice-message-time",children:T(s.durationMs)})]})})}),e.jsx(je,{messageId:s.id,className:"tts-playback-widget-content",text:""})]})}const be=w(Ne);function ye({message:s,showTime:t=!0}){const a=s.role==="user",n=()=>{if(s.role==="user"){if(s.kind==="STT Stream")return e.jsx(ie,{message:s,showTime:t});if(s.kind==="STT File")return e.jsx(le,{message:s,showTime:t});if(s.kind==="TTS")return e.jsx(ue,{message:s,showTime:t})}if(s.role==="assistant"){if(s.kind==="Transcription")return e.jsx(fe,{message:s,showTime:t});if(s.kind==="Structured")return e.jsx(pe,{message:s,showTime:t});if(s.kind==="Playback")return e.jsx(be,{message:s,showTime:t})}return e.jsxs("div",{className:"chat-message__unsupported",children:[e.jsxs("p",{className:"chat-message__unsupported-title",children:["Unsupported message type: ",s.kind," / ",s.role]}),s.content&&e.jsx("p",{className:"chat-message__unsupported-content",children:s.content})]})};return e.jsx("div",{className:y("ChatMessage","chat-message",a?"chat-message--user":"chat-message--assistant"),children:e.jsx("div",{className:`chat-message__content ${a?"chat-message__content--user":"chat-message__content--assistant"}`,children:n()})})}function Se(){return e.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-[#212529] rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-2xl",children:"AI"})}),e.jsx("h3",{className:"text-[#212529] text-xl font-semibold mb-2",children:"Aiola Api APP"}),e.jsx("p",{className:"text-[#6c757d] text-sm leading-relaxed",children:"Transcribe voice recordings or upload audio files. Use the microphone to record speech or upload files for transcription."})]})})}function Pe({messages:s}){const t=l.useRef(null),a=[...s].sort((n,i)=>{if(n.conversation_session_id!==i.conversation_session_id)return i.createdAt-n.createdAt;const m=n.kind==="Structured",g=i.kind==="Structured",v=n.kind==="Transcription",j=i.kind==="Transcription";return m&&j?-1:v&&g?1:i.createdAt-n.createdAt});return l.useEffect(()=>{t.current&&(t.current.scrollTop=0)},[s.length]),s.length===0?e.jsx(Se,{}):e.jsx("div",{ref:t,className:y("ChatMessageList","chat-message-list"),children:a.map(n=>e.jsx(ye,{message:n,showTime:!0},n.id))})}export{Pe as ChatMessageList};
