import{j as e}from"./ui-DXEsCjYO.js";import{r as o}from"./vendor-B6OAZll8.js";import{u as B}from"./audio-B1K76-a3.js";import{c as x,f as w,s as A,b as F,B as _}from"./index-urjlV3O_.js";import{f as z,m as $,i as G,n as K,o as O,p as X,q as H,r as J,s as Q,t as Y,u as Z,v as ee}from"./icons-0o0JEzD5.js";import{c as se,b as E}from"./state-BMzes8HB.js";import{u as te}from"./useConnection-BggP5CuE.js";import{t as I}from"./utils-E4Pq5uL6.js";import"./sdk-9Bd1H_oq.js";const ae=(s=100)=>{const t=[];for(let a=0;a<s;a++){const r=Math.sin(a/8)*.4+.5,i=Math.random()*.3;t.push(Math.max(.1,Math.min(1,r+i)))}return t};function ne({isUser:s=!1,isRecording:t=!1,audioUrl:a,durationMs:r}){const i=o.useRef(null),p=o.useRef(null),[g,f]=o.useState(!!a);return o.useEffect(()=>{if(i.current){if(a&&!t){const u=B.create({container:i.current,waveColor:s?"rgba(0, 0, 0, 0.5)":"rgba(255, 255, 255, 0.5)",progressColor:s?"#000000":"#ffffff",height:60,barWidth:2,barGap:1,barRadius:2,cursorWidth:0,normalize:!0,url:a});return u.on("ready",()=>{f(!1)}),u.on("error",m=>{console.error("WaveSurfer error:",m),f(!1)}),p.current=u,()=>{u.destroy()}}else if(!t){const u=ae(100),m=B.create({container:i.current,waveColor:s?"rgba(0, 0, 0, 0.6)":"rgba(255, 255, 255, 0.6)",progressColor:s?"#000000":"#ffffff",height:60,barWidth:2,barGap:1,barRadius:2,cursorWidth:0,normalize:!0});return m.load("",[u],r?r/1e3:5),p.current=m,f(!1),()=>{m.destroy()}}}},[a,t,s,r]),t?e.jsx("div",{className:"flex items-center justify-center gap-0.5 h-16 my-2 px-4 rounded-lg bg-opacity-10 w-full max-w-full overflow-hidden",children:Array.from({length:50}).map((m,h)=>e.jsx("div",{className:`w-1 rounded-full ${s?"bg-black/80":"bg-white/80"} animate-pulse`,style:{height:`${Math.random()*40+20}px`,animationDelay:`${h*30}ms`,animationDuration:`${800+Math.random()*400}ms`}},h))}):e.jsxs("div",{className:"my-2 px-2 min-w-[300px]",children:[g&&e.jsx("div",{className:"flex items-center justify-center h-16",children:e.jsx("span",{className:"text-xs text-gray-500",children:"Loading waveform..."})}),e.jsx("div",{ref:i,className:`${g?"hidden":""}`})]})}function b(s){return function(a){const{message:r,showTime:i=!0,...p}=a,f=r.role==="assistant"&&r.kind==="Playback"?"100%":"60%";return e.jsxs("div",{className:"flex flex-col",style:{maxWidth:f},children:[e.jsx(s,{...p,message:r,showTime:i}),e.jsx("span",{className:"timestamp",style:{alignSelf:r.role==="user"?"flex-end":"flex-start"},children:new Date(r.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})}}function re({message:s,showTime:t,className:a}){return e.jsx("div",{className:x("SttStreamRequestMessage",a),children:e.jsxs("div",{className:"voice-message-header",children:[e.jsx("div",{className:"voice-message-info",children:e.jsxs("div",{className:"voice-message-icon-text",children:[e.jsx(z,{className:"voice-message-icon text-black"}),e.jsx("span",{className:"voice-message-label text-black",children:"STT Stream"}),t&&e.jsx("span",{className:"voice-message-time text-black",children:w(s.durationMs)})]})}),e.jsx("div",{className:"waveform-container",children:e.jsx(ne,{isUser:!0,isRecording:s.isRecording||!1,durationMs:s.durationMs})}),s.status==="error"&&s.error&&e.jsx("div",{className:"voice-message-error",children:e.jsxs("span",{className:"voice-message-error-text text-red-600",children:["Error: ",s.error]})})]})})}const ce=b(re);function ie({message:s,showTime:t,className:a}){return e.jsx("div",{className:x("SttFileRequestMessage",a),children:e.jsxs("div",{className:"file-message-indicator",children:[s.status==="processing"?e.jsx($,{className:"file-message-icon animate-spin text-black"}):e.jsx(G,{className:"file-message-icon text-black"}),e.jsx("span",{className:"file-message-text text-black",children:s.status==="processing"?"Processing file...":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"voice-message-label text-black",children:"STT File"})," ",e.jsx("span",{className:"voice-message-time text-black",children:s.fileName||"upload"}),t&&e.jsx("span",{className:"voice-message-time text-black",children:w(s.durationMs)})]})})]})})}const oe=b(ie);function le({message:s,showTime:t,className:a}){return e.jsxs("div",{className:x("TtsRequestMessage",a,"tts-request-message"),children:[e.jsx("div",{className:"voice-message-header",children:e.jsx("div",{className:"voice-message-info",children:e.jsxs("div",{className:"voice-message-icon-text",children:[e.jsx(K,{className:"voice-tts-icon text-black"}),e.jsx("span",{className:"voice-message-label text-black",children:"TTS"}),e.jsx(O,{className:"voice-message-icon text-black"}),e.jsx("span",{className:"voice-message-time text-black",children:s.voice||"tara"}),t&&e.jsx("span",{className:"voice-message-time text-black",children:w(s.durationMs)})]})})}),s.content&&e.jsx("p",{className:"message-content-request",children:s.content})]})}const de=b(le);function ue({message:s,showTime:t,className:a}){return e.jsxs("div",{className:x("TranscriptResponseMessage",a),children:[e.jsx("div",{className:"transcript-message-header",children:e.jsx("div",{className:"transcript-message-info",children:e.jsxs("div",{className:"transcript-message-icon-text",children:[e.jsx(X,{className:"transcript-message-icon"}),e.jsx("span",{className:"transcript-message-label text-black",children:"Transcription"}),t&&e.jsx("span",{className:"voice-message-time text-black",children:w(s.durationMs)})]})})}),s.content&&e.jsx("p",{className:"message-content-response",children:s.content})]})}const me=b(ue);function pe({message:s,showTime:t,className:a}){const r=i=>JSON.stringify(i,null,2).replace(/(".*?")(?=\s*:)/g,'<span class="json-key">$1</span>').replace(/:\s*(".*?")/g,': <span class="json-string">$1</span>').replace(/:\s*(\d+(?:\.\d+)?)/g,': <span class="json-number">$1</span>').replace(/:\s*(true|false)/g,': <span class="json-boolean">$1</span>').replace(/:\s*(null)/g,': <span class="json-null">$1</span>');return e.jsxs("div",{className:x("StructuredResponseMessage","structured-response-message",a),children:[e.jsx("div",{className:"transcript-message-header",children:e.jsx("div",{className:"transcript-message-info",children:e.jsxs("div",{className:"transcript-message-icon-text",children:[e.jsx(H,{className:"transcript-message-icon"}),e.jsx("span",{className:"transcript-message-label",children:"Structured Data"})]})})}),s.structuredData&&e.jsx("div",{className:"structured-data-container",children:e.jsx("pre",{className:"structured-data-json",dangerouslySetInnerHTML:{__html:r(s.structuredData)}})})]})}const fe=b(pe);function xe(s){const t=s.environment;return{apiKey:s[t].connection.apiKey,baseUrl:s[t].connection.baseUrl,authBaseUrl:s[t].connection.authBaseUrl,workflowId:s[t].connection.workflowId,environment:t,stt:s[t].stt,tts:s[t].tts}}function he(){const s=se(A),{getClient:t,isConnected:a,sessionId:r}=te(),[i,p]=o.useState(!1),g=o.useCallback(async(f,u)=>{try{p(!0);const m=await t(),h=xe(s),N=await m.tts.synthesize({text:f,voice:u||h.tts.voice,language:h.tts.language}),y=[],k=N.getReader();try{for(;;){const{done:c,value:v}=await k.read();if(c)break;y.push(v)}}finally{k.releaseLock()}const S=y.reduce((c,v)=>c+v.length,0),j=new Uint8Array(S);let T=0;for(const c of y)j.set(c,T),T+=c.length;return new Blob([j],{type:"audio/mpeg"})}finally{p(!1)}},[t,s]);return{isGenerating:i,isConnected:a,sessionId:r,generateTTS:g}}function ge(s){const t=s.environment;return{apiKey:s[t].connection.apiKey,baseUrl:s[t].connection.baseUrl,authBaseUrl:s[t].connection.authBaseUrl,workflowId:s[t].connection.workflowId,environment:t,stt:s[t].stt,tts:s[t].tts}}function je({messageId:s,text:t,className:a=""}){const[r,i]=E(F),[p]=E(A),g=ge(p),[f,u]=o.useState(null),[m,h]=o.useState(!1),[N,y]=o.useState(0),[k,S]=o.useState(0),[j,T]=o.useState(1),c=o.useRef(null),v=o.useRef(null),{generateTTS:U,isGenerating:C}=he(),M=r.playingMessageId===s;o.useEffect(()=>()=>{c.current&&(c.current.pause(),c.current=null)},[]),o.useEffect(()=>{const n=c.current;if(!n)return;const l=()=>S(n.currentTime),d=()=>y(n.duration);return n.addEventListener("timeupdate",l),n.addEventListener("loadedmetadata",d),()=>{n.removeEventListener("timeupdate",l),n.removeEventListener("loadedmetadata",d)}},[M]);const q=async()=>{if(M){c.current&&c.current.pause(),i(n=>({...n,playingMessageId:void 0}));return}r.playingMessageId&&c.current&&c.current.pause();try{if(h(!0),!f){if(!g.apiKey){I.error("Please configure your API key first");return}const d=await U(t);u(d)}const n=URL.createObjectURL(f||new Blob),l=new Audio(n);c.current=l,l.volume=j,l.addEventListener("ended",()=>{i(d=>({...d,playingMessageId:void 0})),S(0),URL.revokeObjectURL(n)}),l.addEventListener("error",d=>{console.error("Audio playback error:",d),I.error("Audio playback failed"),i(R=>({...R,playingMessageId:void 0})),URL.revokeObjectURL(n)}),i(d=>({...d,playingMessageId:s})),await l.play()}catch(n){console.error("TTS Error:",n),I.error("Text-to-speech failed")}finally{h(!1)}},W=n=>{if(!c.current||!v.current)return;const l=v.current.getBoundingClientRect(),d=n.clientX-l.left,R=l.width,P=d/R*N;c.current.currentTime=P,S(P)},D=n=>{const l=parseFloat(n.target.value);T(l),c.current&&(c.current.volume=l)},L=n=>{if(isNaN(n))return"0:00";const l=Math.floor(n/60),d=Math.floor(n%60);return`${l}:${d.toString().padStart(2,"0")}`},V=N>0?k/N*100:0;return e.jsx("div",{className:x("TTSPlaybackWidget",a),children:e.jsxs("div",{className:"tts-playback-controls",children:[e.jsxs("div",{className:"tts-top-row",children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:q,disabled:C||m,className:"tts-play-button",children:C||m?e.jsx($,{className:"h-4 w-4 animate-spin"}):M?e.jsx(J,{className:"h-4 w-4"}):e.jsx(Q,{className:"h-4 w-4"})}),e.jsxs("div",{className:"tts-progress-container",children:[e.jsx("div",{className:"tts-progress-wrapper",children:e.jsx("div",{className:"tts-progress-track",ref:v,onClick:W,children:e.jsx("div",{className:"tts-progress-fill",style:{width:`${V}%`}})})}),e.jsxs("div",{className:"tts-time-display",children:[e.jsx("span",{className:"tts-current-time",children:L(k)}),e.jsx("span",{className:"tts-duration",children:L(N)})]})]})]}),e.jsxs("div",{className:"tts-volume-control",children:[e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>{const n=j>0?0:1;T(n),c.current&&(c.current.volume=n)},className:"tts-volume-button",children:j>0?e.jsx(Y,{className:"h-4 w-4"}):e.jsx(Z,{className:"h-4 w-4"})}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:j,onChange:D,className:"tts-volume-slider"})]})]})})}function ve({message:s,showTime:t,className:a}){return e.jsxs("div",{className:x("VoiceResponseMessage",a),children:[e.jsx("div",{className:"transcript-message-header",children:e.jsx("div",{className:"transcript-message-info",children:e.jsxs("div",{className:"transcript-message-icon-text",children:[e.jsx(ee,{className:"transcript-message-icon"}),e.jsx("span",{className:"transcript-message-label text-black",children:"TTS Playback"}),t&&s.durationMs&&e.jsx("span",{className:"voice-message-time",children:w(s.durationMs)})]})})}),e.jsx(je,{messageId:s.id,className:"tts-playback-widget-content",text:""})]})}const Ne=b(ve);function be({message:s,showTime:t=!0}){const a=s.role==="user",r=()=>{if(s.role==="user"){if(s.kind==="STT Stream")return e.jsx(ce,{message:s,showTime:t});if(s.kind==="STT File")return e.jsx(oe,{message:s,showTime:t});if(s.kind==="TTS")return e.jsx(de,{message:s,showTime:t})}if(s.role==="assistant"){if(s.kind==="Transcription")return e.jsx(me,{message:s,showTime:t});if(s.kind==="Structured")return e.jsx(fe,{message:s,showTime:t});if(s.kind==="Playback")return e.jsx(Ne,{message:s,showTime:t})}return e.jsxs("div",{className:"chat-message__unsupported",children:[e.jsxs("p",{className:"chat-message__unsupported-title",children:["Unsupported message type: ",s.kind," / ",s.role]}),s.content&&e.jsx("p",{className:"chat-message__unsupported-content",children:s.content})]})};return e.jsx("div",{className:x("ChatMessage","chat-message",a?"chat-message--user":"chat-message--assistant"),children:e.jsx("div",{className:`chat-message__content ${a?"chat-message__content--user":"chat-message__content--assistant"}`,children:r()})})}function ye(){return e.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-[#212529] rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-2xl",children:"AI"})}),e.jsx("h3",{className:"text-[#212529] text-xl font-semibold mb-2",children:"Aiola Api APP"}),e.jsx("p",{className:"text-[#6c757d] text-sm leading-relaxed",children:"Transcribe voice recordings or upload audio files. Use the microphone to record speech or upload files for transcription."})]})})}function Be({messages:s}){const t=o.useRef(null),a=[...s].sort((r,i)=>i.createdAt-r.createdAt);return o.useEffect(()=>{t.current&&(t.current.scrollTop=0)},[s.length]),s.length===0?e.jsx(ye,{}):e.jsx("div",{ref:t,className:x("ChatMessageList","chat-message-list"),children:a.map(r=>e.jsx(be,{message:r,showTime:!0},r.id))})}export{Be as ChatMessageList};
