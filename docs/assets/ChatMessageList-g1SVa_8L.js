import{j as e}from"./ui-c6rpaoQp.js";import{r as u}from"./vendor-B6OAZll8.js";import{c as z,b as I}from"./state-BMzes8HB.js";import{u as D}from"./audio-B1K76-a3.js";import{h as J,c as A,i as R,s as P,g as q,B as C}from"./index-TS-7Cj9X.js";import{g as X,k as _,j as Q,l as Y,m as Z,n as W,o as V,p as ee,q as te,r as se,s as re,t as ne}from"./icons-BcCThlEi.js";import{u as ae}from"./useConnection-ChurR88M.js";import{t as w}from"./utils-E4Pq5uL6.js";import"./sdk-_0emOJGD.js";const oe=(t=100)=>{const s=[];for(let n=0;n<t;n++){const r=Math.sin(n/8)*.4+.5,i=Math.random()*.3;s.push(Math.max(.1,Math.min(1,r+i)))}return s};function ie({isUser:t=!1,isRecording:s=!1,audioUrl:n,durationMs:r,messageId:i}){const h=u.useRef(null),T=u.useRef(null),[S,v]=u.useState(!!n),j=z(J),N=i?j.messages.find(d=>d.id===i):null,m=(N==null?void 0:N.amplitudeHistory)||[];if(u.useEffect(()=>{if(h.current){if(n&&!s){const d=D.create({container:h.current,waveColor:t?"rgba(0, 0, 0, 0.5)":"rgba(255, 255, 255, 0.5)",progressColor:t?"#000000":"#ffffff",height:60,barWidth:2,barGap:1,barRadius:2,cursorWidth:0,normalize:!0,url:n});return d.on("ready",()=>{v(!1)}),d.on("error",g=>{console.error("WaveSurfer error:",g),v(!1)}),T.current=d,()=>{d.destroy()}}else if(!s){const d=oe(100),g=D.create({container:h.current,waveColor:t?"rgba(0, 0, 0, 0.6)":"rgba(255, 255, 255, 0.6)",progressColor:t?"#000000":"#ffffff",height:60,barWidth:2,barGap:1,barRadius:2,cursorWidth:0,normalize:!0});return g.load("",[d],r?r/1e3:5),T.current=g,v(!1),()=>{g.destroy()}}}},[n,s,t,r,m,i]),m.length>0){const c=m.length>0?m.slice(-50).map(a=>{const o=(a==null?void 0:a.normalizedPeak)||0;return Math.max(6,o*52+6)}):[];return e.jsx("div",{className:"flex items-center justify-center gap-0.5 h-16 my-2 px-4 rounded-lg bg-opacity-10 w-full max-w-full overflow-hidden",children:Array.from({length:50}).map((p,a)=>e.jsx("div",{className:`w-1 rounded-full ${t?"bg-black/80":"bg-white/80"}`,style:{height:`${c[a]||6}px`}},a))})}if(s){const c=m.length>0?m.slice(-50).map(a=>{const o=(a==null?void 0:a.normalizedPeak)||0;return Math.max(6,o*52+6)}):Array.from({length:50},()=>Math.random()*52+6);return e.jsx("div",{className:"flex items-center justify-center gap-0.5 h-16 my-2 px-4 rounded-lg bg-opacity-10 w-full max-w-full overflow-hidden",children:Array.from({length:50}).map((p,a)=>e.jsx("div",{className:`w-1 rounded-full transition-all duration-100 ${t?"bg-black/80":"bg-white/80"}`,style:{height:`${c[a]}px`,animationDelay:`${a*30}ms`,animationDuration:`${800+Math.random()*400}ms`}},a))})}return n&&!m.length?e.jsxs("div",{className:"my-2 px-2 min-w-[300px]",children:[S&&e.jsx("div",{className:"flex items-center justify-center h-16",children:e.jsx("span",{className:"text-xs text-gray-500",children:"Loading waveform..."})}),e.jsx("div",{ref:h,className:`${S?"hidden":""}`})]}):e.jsx("div",{className:"flex items-center justify-center h-16 my-2",children:e.jsx("span",{className:"text-xs text-gray-400",children:"No waveform data"})})}function E(t){return function(n){const{message:r,showTime:i=!0,...h}=n;return e.jsxs("div",{className:"flex flex-col",style:{maxWidth:"100%"},children:[e.jsx(t,{...h,message:r,showTime:i}),e.jsx("span",{className:"timestamp",style:{alignSelf:r.role==="user"?"flex-end":"flex-start"},children:new Date(r.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})}}function ce({message:t,showTime:s,className:n}){return e.jsx("div",{className:A("SttStreamRequestMessage",n),children:e.jsxs("div",{className:"voice-message-header",children:[e.jsx("div",{className:"voice-message-info",children:e.jsxs("div",{className:"voice-message-icon-text",children:[e.jsx(X,{className:"voice-message-icon text-black"}),e.jsx("span",{className:"voice-message-label text-black",children:"STT Stream"}),s&&e.jsx("span",{className:"voice-message-time text-black",children:R(t.durationMs)})]})}),e.jsx("div",{className:"waveform-container",children:e.jsx(ie,{isUser:!0,isRecording:t.isRecording||!1,durationMs:t.durationMs,messageId:t.id})}),t.status==="error"&&t.error&&e.jsx("div",{className:"voice-message-error",children:e.jsxs("span",{className:"voice-message-error-text text-red-600",children:["Error: ",t.error]})})]})})}const le=E(ce);function ue({message:t,showTime:s,className:n}){return e.jsx("div",{className:A("SttFileRequestMessage",n),children:e.jsxs("div",{className:"file-message-indicator",children:[t.status==="processing"?e.jsx(_,{className:"file-message-icon animate-spin text-black"}):e.jsx(Q,{className:"file-message-icon text-black"}),e.jsx("span",{className:"file-message-text text-black",children:t.status==="processing"?"Processing file...":e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"voice-message-label text-black",children:"STT File"})," ",e.jsx("span",{className:"voice-message-time text-black",children:t.fileName||"upload"}),s&&e.jsx("span",{className:"voice-message-time text-black",children:R(t.durationMs)})]})})]})})}const de=E(ue);function me({message:t,showTime:s,className:n}){return e.jsxs("div",{className:A("TtsRequestMessage",n,"tts-request-message"),children:[e.jsx("div",{className:"voice-message-header",children:e.jsx("div",{className:"voice-message-info",children:e.jsxs("div",{className:"voice-message-icon-text",children:[e.jsx(Y,{className:"voice-tts-icon text-black"}),e.jsx("span",{className:"voice-message-label text-black",children:"TTS"}),e.jsx(Z,{className:"voice-message-icon text-black"}),e.jsx("span",{className:"voice-message-time text-black",children:t.voice||"tara"}),s&&e.jsx("span",{className:"voice-message-time text-black",children:R(t.durationMs)})]})})}),t.content&&e.jsx("p",{className:"message-content-request",children:t.content})]})}const fe=E(me);function he(t){const s=t.environment;return{apiKey:t[s].connection.apiKey,baseUrl:t[s].connection.baseUrl,authBaseUrl:t[s].connection.authBaseUrl,workflowId:t[s].connection.workflowId,environment:s,stt:t[s].stt,tts:t[s].tts}}function K(){const t=z(P),{getClient:s,isConnected:n,sessionId:r}=ae(),[i,h]=u.useState(!1),T=u.useCallback(async(S,v)=>{try{h(!0),console.log("TTS: Starting generation",{text:S.substring(0,50)+"...",voice:v});const j=await s();console.log("TTS: Client obtained");const N=he(t);console.log("TTS: Settings",{voice:v||N.tts.voice,language:N.tts.language,hasApiKey:!!N.apiKey});const m=await j.tts.synthesize({text:S,voice:v||N.tts.voice,language:N.tts.language});console.log("TTS: Stream obtained");const d=[],g=m.getReader();try{for(;;){const{done:y,value:x}=await g.read();if(y)break;d.push(x)}}finally{g.releaseLock()}const c=d.reduce((y,x)=>y+x.length,0);if(console.log("TTS: Total audio length",c),c===0)throw new Error("No audio data received from TTS service");const p=new Uint8Array(c);let a=0;for(const y of d)p.set(y,a),a+=y.length;let o;try{o=new Blob([p],{type:"audio/mpeg"}),console.log("TTS: Blob created with audio/mpeg",{size:o.size,type:o.type})}catch{console.log("TTS: audio/mpeg failed, trying audio/mp3"),o=new Blob([p],{type:"audio/mp3"}),console.log("TTS: Blob created with audio/mp3",{size:o.size,type:o.type})}return o}catch(j){throw console.error("TTS Generation Error:",j),j}finally{h(!1)}},[s,t]);return{isGenerating:i,isConnected:n,sessionId:r,generateTTS:T}}function pe(t){const s=t.environment;return{apiKey:t[s].connection.apiKey,baseUrl:t[s].connection.baseUrl,authBaseUrl:t[s].connection.authBaseUrl,workflowId:t[s].connection.workflowId,environment:s,stt:t[s].stt,tts:t[s].tts}}function H({messageId:t,text:s,className:n=""}){const[r,i]=I(q),[h]=I(P),T=pe(h),[S,v]=u.useState(null),j=u.useRef(null),{generateTTS:N,isGenerating:m}=K(),d=r.playingMessageId===t;u.useEffect(()=>()=>{j.current&&(j.current.pause(),j.current=null)},[]),u.useEffect(()=>{v(null)},[s,T.tts.voice,T.tts.language]);const g=async()=>{if(d){r.currentAudioElement&&(r.currentAudioElement.pause(),r.currentAudioElement.currentTime=0),i(c=>({...c,playingMessageId:void 0,currentAudioElement:null}));return}r.currentAudioElement&&(r.currentAudioElement.pause(),r.currentAudioElement.currentTime=0);try{if(!T.apiKey){w.error("Please configure your API key first");return}if(!s||s.trim().length===0){w.error("No text to convert to speech");return}let c;S?(console.log("TTS Button: Using cached audio"),c=S):(console.log("TTS Button: Generating fresh audio for text:",s.substring(0,100)+"..."),c=await N(s),console.log("TTS Button: Audio generated successfully",{size:c.size}),v(c));const p=URL.createObjectURL(c),a=new Audio(p);j.current=a;let o=0;const y=2;for(;o<=y;)try{await new Promise((x,k)=>{const M=setTimeout(()=>{k(new Error("Audio loading timeout"))},3e3);a.addEventListener("canplaythrough",()=>{clearTimeout(M),x()},{once:!0}),a.addEventListener("error",B=>{clearTimeout(M),console.error("Audio loading error:",B),k(new Error("Audio failed to load"))},{once:!0}),a.load()});break}catch(x){if(o++,o>y)throw x;console.log(`TTS: Audio load attempt ${o} failed, retrying...`),await new Promise(k=>setTimeout(k,100))}a.addEventListener("ended",()=>{i(x=>({...x,playingMessageId:void 0,currentAudioElement:null})),URL.revokeObjectURL(p)}),a.addEventListener("error",x=>{console.error("Audio playback error:",x),w.error("Audio playback failed"),i(k=>({...k,playingMessageId:void 0,currentAudioElement:null})),URL.revokeObjectURL(p)}),i(x=>({...x,playingMessageId:t,currentAudioElement:a})),await a.play()}catch(c){console.error("TTS Error:",c),c instanceof Error?c.message.includes("API key")?w.error("API key is required for text-to-speech"):c.message.includes("No audio data")?w.error("No audio data received from TTS service"):c.message.includes("network")||c.message.includes("fetch")?w.error("Network error: Check your connection and API settings"):w.error(`TTS failed: ${c.message}`):w.error("Text-to-speech failed")}};return e.jsx(C,{variant:"ghost",size:"sm",onClick:g,disabled:m,className:`h-6 w-6 p-0 hover:bg-transparent ${n}`,children:m?e.jsx(_,{className:"h-3 w-3 animate-spin"}):d?e.jsx(W,{className:"h-3 w-3"}):e.jsx(V,{className:"h-3 w-3"})})}function ge({message:t,showTime:s,className:n}){return e.jsxs("div",{className:A("TranscriptResponseMessage",n),children:[e.jsx("div",{className:"transcript-message-header",children:e.jsx("div",{className:"transcript-message-info",children:e.jsxs("div",{className:"transcript-message-icon-text",children:[e.jsx(ee,{className:"transcript-message-icon"}),e.jsx("span",{className:"transcript-message-label text-black",children:"Transcription"}),s&&e.jsx("span",{className:"voice-message-time text-black",children:R(t.durationMs)})]})})}),t.content&&e.jsxs("div",{className:"transcript-content-container",children:[e.jsx("p",{className:"message-content-response",children:t.content}),e.jsx("div",{className:"tts-controls",children:e.jsx(H,{messageId:t.id,text:t.content,className:"tts-button-response"})})]})]})}const xe=E(ge);function ve({message:t,showTime:s,className:n}){const r=i=>JSON.stringify(i,null,2).replace(/(".*?")(?=\s*:)/g,'<span class="json-key">$1</span>').replace(/:\s*(".*?")/g,': <span class="json-string">$1</span>').replace(/:\s*(\d+(?:\.\d+)?)/g,': <span class="json-number">$1</span>').replace(/:\s*(true|false)/g,': <span class="json-boolean">$1</span>').replace(/:\s*(null)/g,': <span class="json-null">$1</span>');return e.jsxs("div",{className:A("StructuredResponseMessage","structured-response-message",n),children:[e.jsx("div",{className:"transcript-message-header",children:e.jsx("div",{className:"transcript-message-info",children:e.jsxs("div",{className:"transcript-message-icon-text",children:[e.jsx(te,{className:"transcript-message-icon"}),e.jsx("span",{className:"transcript-message-label",children:"Structured Data"})]})})}),t.structuredData&&e.jsxs("div",{className:"structured-data-container",children:[e.jsx("pre",{className:"structured-data-json",dangerouslySetInnerHTML:{__html:r(t.structuredData)}}),e.jsx("div",{className:"tts-controls",children:e.jsx(H,{messageId:t.id,text:JSON.stringify(t.structuredData,null,2),className:"tts-button-response"})})]})]})}const je=E(ve);function Ne(t){const s=t.environment;return{apiKey:t[s].connection.apiKey,baseUrl:t[s].connection.baseUrl,authBaseUrl:t[s].connection.authBaseUrl,workflowId:t[s].connection.workflowId,environment:s,stt:t[s].stt,tts:t[s].tts}}function ye({messageId:t,text:s,className:n=""}){const[r,i]=I(q),[h]=I(P),T=Ne(h),[S,v]=u.useState(null),[j,N]=u.useState(!1),[m,d]=u.useState(0),[g,c]=u.useState(0),[p,a]=u.useState(1),o=u.useRef(null),y=u.useRef(null),{generateTTS:x,isGenerating:k}=K(),M=r.playingMessageId===t;u.useEffect(()=>()=>{o.current&&(o.current.pause(),o.current=null)},[]),u.useEffect(()=>{const l=o.current;if(!l)return;const f=()=>c(l.currentTime),b=()=>d(l.duration);return l.addEventListener("timeupdate",f),l.addEventListener("loadedmetadata",b),()=>{l.removeEventListener("timeupdate",f),l.removeEventListener("loadedmetadata",b)}},[M]);const B=async()=>{if(M){r.currentAudioElement&&(r.currentAudioElement.pause(),r.currentAudioElement.currentTime=0),i(l=>({...l,playingMessageId:void 0,currentAudioElement:null}));return}r.currentAudioElement&&(r.currentAudioElement.pause(),r.currentAudioElement.currentTime=0);try{if(N(!0),!S){if(!T.apiKey){w.error("Please configure your API key first");return}const b=await x(s);v(b)}const l=URL.createObjectURL(S||new Blob),f=new Audio(l);o.current=f,f.volume=p,f.addEventListener("ended",()=>{i(b=>({...b,playingMessageId:void 0,currentAudioElement:null})),c(0),URL.revokeObjectURL(l)}),f.addEventListener("error",b=>{console.error("Audio playback error:",b),w.error("Audio playback failed"),i(L=>({...L,playingMessageId:void 0,currentAudioElement:null})),URL.revokeObjectURL(l)}),i(b=>({...b,playingMessageId:t,currentAudioElement:f})),await f.play()}catch(l){console.error("TTS Error:",l),w.error("Text-to-speech failed")}finally{N(!1)}},O=l=>{if(!o.current||!y.current)return;const f=y.current.getBoundingClientRect(),b=l.clientX-f.left,L=f.width,$=b/L*m;o.current.currentTime=$,c($)},F=l=>{const f=parseFloat(l.target.value);a(f),o.current&&(o.current.volume=f)},U=l=>{if(isNaN(l))return"0:00";const f=Math.floor(l/60),b=Math.floor(l%60);return`${f}:${b.toString().padStart(2,"0")}`},G=m>0?g/m*100:0;return e.jsx("div",{className:A("TTSPlaybackWidget",n),children:e.jsxs("div",{className:"tts-playback-controls",children:[e.jsxs("div",{className:"tts-top-row",children:[e.jsx(C,{variant:"ghost",size:"sm",onClick:B,disabled:k||j,className:"tts-play-button",children:k||j?e.jsx(_,{className:"h-4 w-4 animate-spin"}):M?e.jsx(se,{className:"h-4 w-4"}):e.jsx(re,{className:"h-4 w-4"})}),e.jsxs("div",{className:"tts-progress-container",children:[e.jsx("div",{className:"tts-progress-wrapper",children:e.jsx("div",{className:"tts-progress-track",ref:y,onClick:O,children:e.jsx("div",{className:"tts-progress-fill",style:{width:`${G}%`}})})}),e.jsxs("div",{className:"tts-time-display",children:[e.jsx("span",{className:"tts-current-time",children:U(g)}),e.jsx("span",{className:"tts-duration",children:U(m)})]})]})]}),e.jsxs("div",{className:"tts-volume-control",children:[e.jsx(C,{variant:"ghost",size:"sm",onClick:()=>{const l=p>0?0:1;a(l),o.current&&(o.current.volume=l)},className:"tts-volume-button",children:p>0?e.jsx(V,{className:"h-4 w-4"}):e.jsx(W,{className:"h-4 w-4"})}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:p,onChange:F,className:"tts-volume-slider"})]})]})})}function be({message:t,showTime:s,className:n}){return e.jsxs("div",{className:A("VoiceResponseMessage",n),children:[e.jsx("div",{className:"transcript-message-header",children:e.jsx("div",{className:"transcript-message-info",children:e.jsxs("div",{className:"transcript-message-icon-text",children:[e.jsx(ne,{className:"transcript-message-icon"}),e.jsx("span",{className:"transcript-message-label text-black",children:"TTS Playback"}),s&&t.durationMs&&e.jsx("span",{className:"voice-message-time",children:R(t.durationMs)})]})})}),e.jsx(ye,{messageId:t.id,className:"tts-playback-widget-content",text:""})]})}const Te=E(be);function Se({message:t,showTime:s=!0}){const n=t.role==="user",r=()=>{if(t.role==="user"){if(t.kind==="STT Stream")return e.jsx(le,{message:t,showTime:s});if(t.kind==="STT File")return e.jsx(de,{message:t,showTime:s});if(t.kind==="TTS")return e.jsx(fe,{message:t,showTime:s})}if(t.role==="assistant"){if(t.kind==="Transcription")return e.jsx(xe,{message:t,showTime:s});if(t.kind==="Structured")return e.jsx(je,{message:t,showTime:s});if(t.kind==="Playback")return e.jsx(Te,{message:t,showTime:s})}return e.jsxs("div",{className:"chat-message__unsupported",children:[e.jsxs("p",{className:"chat-message__unsupported-title",children:["Unsupported message type: ",t.kind," / ",t.role]}),t.content&&e.jsx("p",{className:"chat-message__unsupported-content",children:t.content})]})};return e.jsx("div",{className:A("ChatMessage","chat-message",n?"chat-message--user":"chat-message--assistant"),children:e.jsx("div",{className:`chat-message__content ${n?"chat-message__content--user":"chat-message__content--assistant"}`,children:r()})})}function we(){return e.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-[#212529] rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-2xl",children:"AI"})}),e.jsx("h3",{className:"text-[#212529] text-xl font-semibold mb-2",children:"Aiola Api APP"}),e.jsx("p",{className:"text-[#6c757d] text-sm leading-relaxed",children:"Transcribe voice recordings or upload audio files. Use the microphone to record speech or upload files for transcription."})]})})}function _e({messages:t}){const s=u.useRef(null),n=[...t].sort((r,i)=>{if(r.conversation_session_id!==i.conversation_session_id)return i.createdAt-r.createdAt;const h=r.kind==="Structured",T=i.kind==="Structured",S=r.kind==="Transcription",v=i.kind==="Transcription";return h&&v?-1:S&&T?1:i.createdAt-r.createdAt});return u.useEffect(()=>{s.current&&(s.current.scrollTop=0)},[t.length]),t.length===0?e.jsx(we,{}):e.jsx("div",{ref:s,className:A("ChatMessageList","chat-message-list"),children:n.map(r=>e.jsx(Se,{message:r,showTime:!0},r.id))})}export{_e as ChatMessageList};
