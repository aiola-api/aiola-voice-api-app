import{j as l}from"./ui-DXEsCjYO.js";import{r as g}from"./vendor-B6OAZll8.js";import{b as K}from"./state-BMzes8HB.js";import{b as re,d as se,s as ce,c as ie,B as ae}from"./index-CeHcYKT_.js";import{u as le}from"./useConnection-NXU-bj3v.js";import{u as de}from"./useSTT-BP0_Uc2C.js";import{t as y}from"./utils-E4Pq5uL6.js";import{e as W,f as Z,g as ue}from"./icons-KOPessbp.js";import"./sdk-9Bd1H_oq.js";function ge(e){const a=e.environment;return{apiKey:e[a].connection.apiKey,baseUrl:e[a].connection.baseUrl,authBaseUrl:e[a].connection.authBaseUrl,workflowId:e[a].connection.workflowId,environment:a,stt:e[a].stt,tts:e[a].tts}}const pe=[{value:"en_US",label:"English (US)",shortLabel:"EN"},{value:"en_GB",label:"English (UK)",shortLabel:"EN"},{value:"es_ES",label:"Spanish (Spain)",shortLabel:"ES"},{value:"fr_FR",label:"French (France)",shortLabel:"FR"},{value:"de_DE",label:"German (Germany)",shortLabel:"DE"},{value:"it_IT",label:"Italian (Italy)",shortLabel:"IT"},{value:"pt_BR",label:"Portuguese (Brazil)",shortLabel:"PT"},{value:"ja_JP",label:"Japanese (Japan)",shortLabel:"JA"},{value:"ko_KR",label:"Korean (Korea)",shortLabel:"KO"},{value:"zh_CN",label:"Chinese (China)",shortLabel:"ZH"}],me=e=>{const a=pe.find(h=>h.value===e);return(a==null?void 0:a.shortLabel)||e},x=(e,a="Conversation Update")=>{console.group(`ðŸ“‹ ${a}`),console.log(`Total messages: ${e.length}`);const h=e.filter(f=>f.kind==="STT Stream"),C=e.filter(f=>f.isRecording===!0);console.log(`STT messages: ${h.length}`),console.log(`Currently recording: ${C.length}`),e.forEach((f,c)=>{const L=f.isRecording?"ðŸ”´":"âšª",U=f.status||"unknown",I=f.kind||"unknown",w=f.durationMs?`${(f.durationMs/1e3).toFixed(1)}s`:"0s";console.log(`${c+1}. ${L} [${I}] ${f.id.substring(0,20)}... | ${U} | ${w}`)}),C.length>0&&console.log("ðŸŽ¤ Currently recording:",C[0].id),console.groupEnd()};function ye(){const[e,a]=K(re),[,h]=K(se),[C]=K(ce),f=ge(C),c=g.useRef(null),{createStreamConnection:L,closeStream:U}=de(),{isConnected:I,sessionId:w,createSession:Q,isConnecting:A,isOnline:X,updateConnectionState:G}=le(),[P,k]=g.useState(!1),[Y,z]=g.useState(!1),_=e.isRecording?"connected":Y?"preparingMic":A||P?"connecting":X&&w?"ready":"idle";g.useEffect(()=>{if(P){const o=setTimeout(()=>{k(!1)},3e3);return()=>clearTimeout(o)}},[P]);const q=_;g.useEffect(()=>{console.log("ðŸ” VoiceControls state:",{computedMicrophoneState:_,isConnecting:A,isConnected:I,sessionId:w,audioState:e.microphoneState})},[_,A,I,w,e.microphoneState]),g.useEffect(()=>{if(console.log("ðŸ” Sync effect triggered:",{audioState:e.microphoneState,computedState:_,isRecording:e.isRecording,shouldSync:e.microphoneState!==_}),e.microphoneState!==_){console.log("ðŸ”„ Syncing audio state with computed state:",{from:e.microphoneState,to:_});const o=w||e.currentSessionId;a(t=>({...t,microphoneState:_,currentSessionId:o}))}},[_,e.microphoneState,e.currentSessionId,e.isRecording,w,a]);const R=g.useRef(null),$=g.useRef(null),b=g.useRef(null),E=g.useRef(null),p=g.useRef(0),u=g.useRef(null),j=g.useRef(new Map),J=g.useRef(new Set);g.useEffect(()=>{if(p.current===0||!e.isRecording)return;const o=setInterval(()=>{const t=Date.now();a(i=>{const r=p.current>0?t-p.current:0;return r>0&&r%1e3<100&&console.log(`Timer running: ${r}ms`),{...i,elapsedMs:i.startedAtMs>0?t-i.startedAtMs:0,sttRequestElapsedMs:r}}),c.current&&p.current>0&&(console.log("ðŸ”„ Updating conversation message duration:",{currentMessageId:c.current,sttStartTime:p.current,elapsed:t-p.current}),h(i=>({...i,messages:i.messages.map(r=>r.id===c.current?(console.log("ðŸ“ Updating STT message:",r.id,"duration:",t-p.current),{...r,durationMs:t-p.current}):r)})))},100);return()=>clearInterval(o)},[e.isRecording,e.startedAtMs,e.sttRequestStartedAtMs,e.currentSessionId,a,h,p]),g.useEffect(()=>()=>{u.current&&(clearInterval(u.current),u.current=null),U(),D()},[]);const D=()=>{b.current&&(b.current.getTracks().forEach(o=>o.stop()),b.current=null),R.current&&R.current.state!=="closed"&&(R.current.close(),R.current=null),$.current=null},F=async o=>{console.log("ðŸŽµ Setting up audio pipeline..."),G({isStreaming:!0,error:void 0}),u.current&&(clearInterval(u.current),u.current=null),console.log("ðŸ”„ Updating message status to streaming for:",c.current),h(t=>{const i=t.messages.map(r=>r.id===c.current?(console.log("âœ… Setting streaming status for message:",r.id),{...r,status:"streaming",content:"ðŸŽ¤ Recording... (Streaming)",isRecording:!0}):(r.isRecording&&console.log("âŒ Clearing isRecording for non-current message:",r.id),{...r,isRecording:!1}));return x(i,"Message Status Updated to Streaming"),{...t,messages:i}});try{const t=R.current.createMediaStreamSource(b.current);$.current=new AudioWorkletNode(R.current,"audio-processor");let i=0;$.current.port.onmessage=r=>{try{o.send(r.data.audio_data),i++,i%50===0&&console.log(`ðŸ”Š Sent ${i} audio packets`)}catch(s){i%100===0&&console.error("âš ï¸ Error sending audio data:",s)}},t.connect($.current),console.log("âœ… Audio pipeline connected"),a(r=>(console.log("ðŸŽ¯ Setting isRecording to true, current state:",{isRecording:r.isRecording,microphoneState:r.microphoneState}),{...r,micAllowed:!0,isRecording:!0,startedAtMs:Date.now(),elapsedMs:0})),z(!1),console.log("âœ… Recording started successfully",{isRecording:!0,currentSessionId:e.currentSessionId,micAllowed:!0})}catch(t){throw console.error("âŒ Error setting up audio pipeline:",t),y.error("Failed to set up audio"),u.current&&(clearInterval(u.current),u.current=null),t}},O=async()=>{if(console.log("ðŸŽ¤ Starting recording..."),!f.apiKey){y.error("Please configure your API key first");return}try{const o=`stt_request_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,t=`recording_${e.currentSessionId||"default"}_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,i={id:o,role:"user",content:"ðŸŽ¤ Recording...",createdAt:Date.now(),sessionId:e.currentSessionId||void 0,conversation_session_id:t,kind:"STT Stream",status:"recording",isRecording:!0};console.log("ðŸŽ¤ Creating new STT message:",o,"with isRecording: true"),c.current=o,j.current.delete(o),a(n=>({...n,currentRecordingMessageId:o})),h(n=>{const T=[...n.messages.map(d=>({...d,isRecording:!1})),i];return x(T,"New STT Message Created"),{...n,messages:T}}),p.current=Date.now(),console.log("ðŸ’¬ Added STT request message to chat:",i.id,"Timer started at:",p.current),z(!0),console.log("ðŸŽ¤ Step 1: Accessing microphone stream...");const r=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}});console.log("âœ… Microphone stream accessed"),b.current=r,console.log("ðŸŽ¤ Step 2: Setting up AudioContext...");try{R.current=new AudioContext({sampleRate:16e3,latencyHint:"interactive"}),R.current.state==="suspended"&&await R.current.resume(),await R.current.audioWorklet.addModule("/aiola-voice-api-app/audio-processor.js"),console.log("âœ… Audio worklet loaded"),console.log("ðŸ”§ Microphone preparation phase started")}catch(n){console.error("âŒ AudioContext setup failed:",n),y.error("Failed to initialize audio system. Please check your browser settings."),D();return}console.log("ðŸ“¡ Step 3: Creating STT stream...");const s=await L();J.current.has(s)?(console.log("ðŸ”„ Reusing existing connection handlers"),s.connected&&(console.log("ðŸ”Œ Connection already connected, setting up audio pipeline..."),setTimeout(async()=>{try{await F(s)}catch(n){console.error("âŒ Error setting up audio pipeline for existing connection:",n)}},0))):(console.log("ðŸ”§ Setting up new connection handlers"),J.current.add(s),s.on("connect",async()=>{console.log("âœ… Stream connected - Setting up audio pipeline..."),y.success("Connected - Recording started");try{await F(s)}catch(n){console.error("âŒ Error in connect handler:",n),B()}}),s.on("transcript",n=>{console.log("test-x New transcript arriving from SDK:",n.transcript),console.log("ðŸ“ Transcript received:",n.transcript),console.log("ðŸ” Current recording message ID:",c.current);const v=c.current;if(!v){console.warn("âš ï¸ No current STT message ID, skipping transcript processing");return}j.current.has(v)||j.current.set(v,new Set);const T=j.current.get(v);if(T.has(n.transcript)){console.log("ðŸ”„ Skipping duplicate transcript:",n.transcript);return}T.add(n.transcript),console.log("âœ… Processing new transcript:",n.transcript),h(d=>{var H;console.log("ðŸ” Total messages:",d.messages.length),console.log("ðŸ” STT Stream messages:",d.messages.filter(S=>S.kind==="STT Stream").length),console.log("ðŸ” Transcription messages:",d.messages.filter(S=>S.kind==="Transcription").length);const m=d.messages.find(S=>S.id===c.current);if(console.log("ðŸ” Current STT message:",m==null?void 0:m.id,m==null?void 0:m.conversation_session_id),!m||!m.conversation_session_id)return console.warn("âš ï¸ No current STT Stream message found or missing conversation_session_id"),d;const M=d.messages.find(S=>S.kind==="Transcription"&&S.conversation_session_id===m.conversation_session_id&&S.role==="assistant");if(console.log("ðŸ” Existing transcription message:",M==null?void 0:M.id,((H=M==null?void 0:M.content)==null?void 0:H.substring(0,100))+"..."),console.log("ðŸ” Looking for transcription message with conversation_session_id:",m.conversation_session_id),M){const S=d.messages.map(N=>{if(N.id===M.id){const V=N.content?`${N.content} ${n.transcript}`:n.transcript;return console.log("test-x Agent STT response updated:",n.transcript,"conversation_session_id:",m==null?void 0:m.conversation_session_id),console.log("âœ… Updating existing transcription message:",n.transcript,"â†’ New content:",V),{...N,content:V,createdAt:Date.now()}}return N});return{...d,messages:S}}else{const S={id:`transcript_${Date.now()}`,role:"assistant",content:n.transcript,createdAt:Date.now(),sessionId:e.currentSessionId||void 0,conversation_session_id:m.conversation_session_id,kind:"Transcription",status:"done",isTranscription:!0};return console.log("test-x New agent STT response created:",n.transcript),console.log("âœ… Creating new transcription message:",n.transcript,"with conversation_session_id:",m.conversation_session_id),console.log("ðŸ“‹ Total messages before adding new transcription:",d.messages.length),{...d,messages:[...d.messages,S]}}})}),s.on("error",n=>{console.error("âŒ Connection Error:",n),y.error(`Error: ${(n==null?void 0:n.message)||"Connection failed"}`),console.log("âŒ Setting error status for message:",c.current),c.current&&h(v=>{const T=v.messages.map(d=>d.id===c.current?(console.log("âœ… Setting error status for message:",d.id),{...d,status:"error",content:"ðŸŽ¤ Recording failed",error:(n==null?void 0:n.message)||"Connection failed",isRecording:!1}):(d.isRecording&&console.log("âŒ Clearing isRecording for message:",d.id),{...d,isRecording:!1}));return x(T,"Recording Error"),{...v,messages:T}}),c.current=null,a(v=>({...v,currentRecordingMessageId:void 0})),B()}),s.on("disconnect",n=>{console.log("ðŸ”Œ Disconnected:",n),n&&n!=="io client disconnect"&&y.error(`Disconnected: ${n}`),u.current&&(clearInterval(u.current),u.current=null)})),E.current=s,console.log("âœ… STT stream created and handlers set up"),s.connected?(console.log("ðŸ”Œ Reusing existing STT connection..."),setTimeout(async()=>{try{await F(s)}catch(n){console.error("âŒ Error setting up audio pipeline for existing connection:",n)}},0)):(console.log("ðŸ”Œ Connection was closed, creating new STT stream..."),s.connect())}catch(o){console.error("âŒ Error starting recording:",o);let t="Failed to start recording";o instanceof Error&&(o.name==="NotAllowedError"?t="Microphone access denied. Please allow microphone permissions.":o.name==="NotFoundError"?t="No microphone found. Please connect a microphone and try again.":o.name==="NotReadableError"?t="Microphone is already in use by another application.":o.name==="OverconstrainedError"?t="Microphone doesn't support the required audio format.":t=o.message),y.error(t),D(),console.log("âŒ Setting error status for message (startRecording):",c.current),c.current&&h(i=>{const r=i.messages.map(s=>s.id===c.current?(console.log("âœ… Setting error status for message:",s.id),{...s,status:"error",content:"ðŸŽ¤ Recording failed",error:t,isRecording:!1}):(s.isRecording&&console.log("âŒ Clearing isRecording for message:",s.id),{...s,isRecording:!1}));return x(r,"Recording Error (Start)"),{...i,messages:r}}),c.current=null,a(i=>({...i,sttRequestStartedAtMs:0,sttRequestElapsedMs:0,currentRecordingMessageId:void 0})),p.current=0}},B=()=>{if(console.log("ðŸ”´ Stopping recording for message:",c.current),c.current){const t=p.current>0?Date.now()-p.current:0;console.log("ðŸ“ Setting message to done status:",c.current,"duration:",t),h(i=>{const r=i.messages.map(s=>s.id===c.current?(console.log("âœ… Setting done status for message:",s.id),{...s,status:"done",durationMs:t,isRecording:!1}):(s.isRecording&&console.log("âŒ Clearing isRecording for message:",s.id),{...s,isRecording:!1}));return x(r,"Recording Completed"),{...i,messages:r}})}G({isStreaming:!1}),E.current&&!u.current&&(u.current=setInterval(()=>{if(E.current&&E.current.connected)try{E.current.send(new ArrayBuffer(0))}catch(t){console.log("Keepalive ping failed:",t),u.current&&(clearInterval(u.current),u.current=null)}},3e4)),D();const o=c.current;c.current=null,console.log("ðŸ§¹ Clearing current recording message ID:",o),a(t=>({...t,isRecording:!1,partialText:"",currentRecordingMessageId:void 0,sttRequestStartedAtMs:0,sttRequestElapsedMs:0})),console.log("ðŸ”´ Recording stopped, microphone in ready state",{isRecording:!1,microphoneState:"ready",currentSessionId:e.currentSessionId,previousMessageId:o,micAllowed:!0}),p.current=0},ee=async()=>{if(console.log("ðŸŽ¤ Microphone button clicked",{computedState:_,audioState:e.microphoneState,isConnected:I,sessionId:e.currentSessionId,isRecording:e.isRecording}),_==="connected"){console.log("ðŸ”´ Currently connected/recording, stopping..."),B();return}if(_==="ready"){console.log("ðŸŽ¤ In ready state, starting recording..."),await O();return}if(!w){console.log("ðŸŽ¤ No session exists, creating session..."),k(!0);try{await ne()}catch(o){console.error("âŒ Error creating session:",o),k(!1)}return}},ne=async()=>{try{console.log("ðŸ”§ Creating new session for microphone recording..."),await Q(),console.log("âœ… Session created successfully:",w),await O()}catch(o){console.error("âŒ Failed to create session:",o),y.error("Failed to create session. Please check your API key in the settings and try again â†’"),k(!1)}},oe=()=>{const o=me(f.stt.language);switch(q){case"connecting":return l.jsxs("div",{className:"voice-controls__mic-container",children:[l.jsx("div",{className:"voice-controls__connecting-indicator",children:l.jsx("div",{className:"voice-controls__connecting-dot"})}),l.jsx(W,{className:"voice-controls__mic-icon--connecting"}),l.jsx("div",{className:"voice-controls__language-indicator",children:o})]});case"connected":return l.jsxs("div",{className:"voice-controls__mic-container",children:[l.jsx(ue,{className:"voice-controls__mic-icon--connected"}),l.jsx("div",{className:"voice-controls__language-indicator",children:o})]});case"ready":return l.jsxs("div",{className:"voice-controls__mic-container",children:[l.jsx(Z,{className:"voice-controls__mic-icon--ready"}),l.jsx("div",{className:"voice-controls__language-indicator",children:o})]});case"preparingMic":return l.jsxs("div",{className:"voice-controls__mic-container",children:[l.jsx("div",{className:"voice-controls__connecting-indicator",children:l.jsx("div",{className:"voice-controls__connecting-dot--white"})}),l.jsx(Z,{className:"voice-controls__mic-icon--preparing"}),l.jsx("div",{className:"voice-controls__language-indicator",children:o})]});default:return l.jsxs("div",{className:"voice-controls__mic-container",children:[l.jsx(W,{className:"voice-controls__mic-icon--idle"}),l.jsx("div",{className:"voice-controls__language-indicator",children:o})]})}},te=()=>{console.log("ðŸ” getButtonClassName-> Getting button class name for state:",q);const o="voice-controls__mic-button",t=(()=>{switch(q){case"connected":return"voice-controls__mic-button--connected";case"ready":return"voice-controls__mic-button--ready";case"connecting":return"voice-controls__mic-button--connecting";case"preparingMic":return"voice-controls__mic-button--preparingMic";default:return"voice-controls__mic-button--idle"}})();return`${o} ${t}`};return l.jsx("div",{className:ie("VoiceControls","voice-controls-buttons"),children:l.jsx(ae,{variant:"ghost",size:"sm",onClick:ee,disabled:A,className:`voice-controls__mic-button ${te()}`,children:oe()})})}export{ye as VoiceControls};
