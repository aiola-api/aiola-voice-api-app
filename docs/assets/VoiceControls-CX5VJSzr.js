import{j as m}from"./ui-c6rpaoQp.js";import{r as _}from"./vendor-B6OAZll8.js";import{b as W}from"./state-BMzes8HB.js";import{g as ge,h as me,s as pe,c as fe,B as Se}from"./index-DbGP0vH-.js";import{u as he}from"./useConnection-XzYsOZzo.js";import{u as _e}from"./useSTT-DBnBJqxn.js";import{t as k}from"./utils-E4Pq5uL6.js";import{g as ee,h as ne,i as Te}from"./icons-BcCThlEi.js";import"./sdk-9Bd1H_oq.js";function ve(n){const u=n.environment;return{apiKey:n[u].connection.apiKey,baseUrl:n[u].connection.baseUrl,authBaseUrl:n[u].connection.authBaseUrl,workflowId:n[u].connection.workflowId,environment:u,stt:n[u].stt,tts:n[u].tts}}const we=[{value:"en_US",label:"English (US)",shortLabel:"EN"},{value:"en_GB",label:"English (UK)",shortLabel:"EN"},{value:"es_ES",label:"Spanish (Spain)",shortLabel:"ES"},{value:"fr_FR",label:"French (France)",shortLabel:"FR"},{value:"de_DE",label:"German (Germany)",shortLabel:"DE"},{value:"it_IT",label:"Italian (Italy)",shortLabel:"IT"},{value:"pt_BR",label:"Portuguese (Brazil)",shortLabel:"PT"},{value:"ja_JP",label:"Japanese (Japan)",shortLabel:"JA"},{value:"ko_KR",label:"Korean (Korea)",shortLabel:"KO"},{value:"zh_CN",label:"Chinese (China)",shortLabel:"ZH"}],Re=n=>{const u=we.find(b=>b.value===n);return(u==null?void 0:u.shortLabel)||n},D=(n,u="Conversation Update")=>{console.group(`ðŸ“‹ ${u}`),console.log(`Total messages: ${n.length}`);const b=n.filter(M=>M.kind==="STT Stream"),v=n.filter(M=>M.isRecording===!0);console.log(`STT messages: ${b.length}`),console.log(`Currently recording: ${v.length}`),n.forEach((M,j)=>{const l=M.isRecording?"ðŸ”´":"âšª",B=M.status||"unknown",K=M.kind||"unknown",A=M.durationMs?`${(M.durationMs/1e3).toFixed(1)}s`:"0s";console.log(`${j+1}. ${l} [${K}] ${M.id.substring(0,20)}... | ${B} | ${A}`)}),v.length>0&&console.log("ðŸŽ¤ Currently recording:",v[0].id),console.groupEnd()};function Ee(){const[n,u]=W(ge),[b,v]=W(me),[M]=W(pe),j=ve(M),l=_.useRef(null),{createStreamConnection:B,closeStream:K}=_e(),{isConnected:A,sessionId:x,createSession:se,isConnecting:H,isOnline:te,updateConnectionState:V}=he(),[O,U]=_.useState(!1),[oe,Z]=_.useState(!1),y=n.isRecording?"connected":oe?"preparingMic":O?"connecting":te&&x?"ready":"idle";_.useEffect(()=>{if(O){const t=setTimeout(()=>{U(!1)},3e3);return()=>clearTimeout(t)}},[O]);const G=y;_.useEffect(()=>{console.log("ðŸ” VoiceControls state:",{computedMicrophoneState:y,isConnecting:H,isConnected:A,sessionId:x,audioState:n.microphoneState})},[y,H,A,x,n.microphoneState]),_.useEffect(()=>{if(console.log("ðŸ” Sync effect triggered:",{audioState:n.microphoneState,computedState:y,isRecording:n.isRecording,shouldSync:n.microphoneState!==y}),n.microphoneState!==y){console.log("ðŸ”„ Syncing audio state with computed state:",{from:n.microphoneState,to:y});const t=x||n.currentSessionId;u(r=>({...r,microphoneState:y,currentSessionId:t}))}},[y,n.microphoneState,n.currentSessionId,n.isRecording,x,u]);const C=_.useRef(null),F=_.useRef(null),E=_.useRef(null),$=_.useRef(null),T=_.useRef(0),S=_.useRef(null),L=_.useRef(new Map),Q=_.useRef(new Set);_.useEffect(()=>{if(T.current===0||!n.isRecording)return;const t=setInterval(()=>{const r=Date.now();u(d=>{const c=T.current>0?r-T.current:0;return c>0&&c%1e3<100&&console.log(`Timer running: ${c}ms`),{...d,elapsedMs:d.startedAtMs>0?r-d.startedAtMs:0,sttRequestElapsedMs:c}}),l.current&&T.current>0&&(console.log("ðŸ”„ Updating conversation message duration:",{currentMessageId:l.current,sttStartTime:T.current,elapsed:r-T.current}),v(d=>({...d,messages:d.messages.map(c=>c.id===l.current?(console.log("ðŸ“ Updating STT message:",c.id,"duration:",r-T.current),{...c,durationMs:r-T.current}):c)})))},100);return()=>clearInterval(t)},[n.isRecording,n.startedAtMs,n.sttRequestStartedAtMs,n.currentSessionId,u,v,T]),_.useEffect(()=>()=>{S.current&&(clearInterval(S.current),S.current=null),K(),P()},[]);const P=()=>{E.current&&(E.current.getTracks().forEach(t=>t.stop()),E.current=null),C.current&&C.current.state!=="closed"&&(C.current.close(),C.current=null),F.current=null},z=async t=>{console.log("ðŸŽµ Setting up audio pipeline..."),V({isStreaming:!0,error:void 0}),S.current&&(clearInterval(S.current),S.current=null),console.log("ðŸ”„ Updating message status to streaming for:",l.current),v(r=>{const d=r.messages.map(c=>c.id===l.current?(console.log("âœ… Setting streaming status for message:",c.id),{...c,status:"streaming",content:"ðŸŽ¤ Recording... (Streaming)",isRecording:!0}):(c.isRecording&&console.log("âŒ Clearing isRecording for non-current message:",c.id),{...c,isRecording:!1}));return D(d,"Message Status Updated to Streaming"),{...r,messages:d}});try{const r=C.current.createMediaStreamSource(E.current);F.current=new AudioWorkletNode(C.current,"audio-processor");let d=0;F.current.port.onmessage=c=>{try{if(t.send(c.data.audio_data),c.data.amplitude){const i=c.data.amplitude,e=l.current;e&&v(g=>{const o=g.messages.map(s=>{if(s.id===e){const a=[...s.amplitudeHistory||[],i].slice(-50);return{...s,amplitudeData:i,amplitudeHistory:a}}return s});return{...g,messages:o}})}d++,d%50===0&&console.log(`ðŸ”Š Sent ${d} audio packets`)}catch(i){d%100===0&&console.error("âš ï¸ Error sending audio data:",i)}},r.connect(F.current),console.log("âœ… Audio pipeline connected"),u(c=>(console.log("ðŸŽ¯ Setting isRecording to true, current state:",{isRecording:c.isRecording,microphoneState:c.microphoneState}),{...c,micAllowed:!0,isRecording:!0,startedAtMs:Date.now(),elapsedMs:0})),Z(!1),console.log("âœ… Recording started successfully",{isRecording:!0,currentSessionId:n.currentSessionId,micAllowed:!0})}catch(r){throw console.error("âŒ Error setting up audio pipeline:",r),k.error("Failed to set up audio"),S.current&&(clearInterval(S.current),S.current=null),r}},X=async()=>{if(console.log("ðŸŽ¤ Starting recording..."),!j.apiKey){k.error("Please configure your API key first");return}try{const t=`stt_request_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,r=`recording_${n.currentSessionId||"default"}_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,d={id:t,role:"user",content:"ðŸŽ¤ Recording...",createdAt:Date.now(),sessionId:n.currentSessionId||void 0,conversation_session_id:r,kind:"STT Stream",status:"recording",isRecording:!0};console.log("ðŸŽ¤ Creating new STT message:",t,"with isRecording: true"),l.current=t,L.current.clear(),u(e=>({...e,currentRecordingMessageId:t})),v(e=>{const o=[...e.messages.map(s=>({...s,isRecording:!1})),d];return D(o,"New STT Message Created"),{...e,messages:o}}),T.current=Date.now(),console.log("ðŸ’¬ Added STT request message to chat:",d.id,"Timer started at:",T.current),Z(!0),console.log("ðŸŽ¤ Step 1: Accessing microphone stream...");const c=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}});console.log("âœ… Microphone stream accessed"),E.current=c,console.log("ðŸŽ¤ Step 2: Setting up AudioContext...");try{C.current=new AudioContext({sampleRate:16e3,latencyHint:"interactive"}),C.current.state==="suspended"&&await C.current.resume(),await C.current.audioWorklet.addModule("/aiola-voice-api-app/audio-processor.js"),console.log("âœ… Audio worklet loaded"),console.log("ðŸ”§ Microphone preparation phase started")}catch(e){console.error("âŒ AudioContext setup failed:",e),k.error("Failed to initialize audio system. Please check your browser settings."),P();return}console.log("ðŸ“¡ Step 3: Creating STT stream...");const i=await B();Q.current.has(i)?(console.log("ðŸ”„ Reusing existing connection handlers"),i.connected&&(console.log("ðŸ”Œ Connection already connected, setting up audio pipeline..."),setTimeout(async()=>{try{await z(i)}catch(e){console.error("âŒ Error setting up audio pipeline for existing connection:",e)}},0))):(console.log("ðŸ”§ Setting up new connection handlers"),Q.current.add(i),i.on("connect",async()=>{console.log("âœ… Stream connected - Setting up audio pipeline..."),k.success("Connected - Recording started");try{await z(i)}catch(e){console.error("âŒ Error in connect handler:",e),J()}}),i.on("transcript",e=>{console.log("test-x New transcript arriving from SDK:",e.transcript),console.log("ðŸ“ Transcript received:",e.transcript),console.log("ðŸ” Current recording message ID:",l.current);let g=l.current;if(!g){console.log("ðŸ” No current STT message ID, looking for STT Stream message to associate transcript...");const o=b.messages.reduce((a,h)=>{const R=h.kind||"unknown";return a[R]=(a[R]||0)+1,a},{});console.log("ðŸ” Message types in conversation:",o);const s=b.messages.filter(a=>a.kind==="STT Stream");console.log("ðŸ” Found",s.length,"STT Stream messages in conversation"),s.length===0&&b.messages.length>0&&(console.warn("âš ï¸ No STT Stream messages found, but conversation has other messages. This suggests a timing issue."),console.log("ðŸ” Latest messages in conversation:",b.messages.slice(-3)));const w=s.filter(a=>b.messages.some(h=>h.kind==="Transcription"&&h.conversation_session_id===a.conversation_session_id)).sort((a,h)=>h.createdAt-a.createdAt);if(console.log("ðŸ” Found",w.length,"STT Stream messages with existing transcriptions"),w.length>0)g=w[0].id,console.log("âœ… Found STT Stream message with existing transcription:",g,"conversation_session_id:",w[0].conversation_session_id);else{const a=s.sort((h,R)=>R.createdAt-h.createdAt);if(a.length>0)g=a[0].id,console.log("âœ… Using last STT Stream message for new transcription:",g,"conversation_session_id:",a[0].conversation_session_id);else{console.warn("âš ï¸ No STT Stream message found to associate transcript with, skipping processing");return}}}v(o=>{var Y;console.log("ðŸ” Total messages:",o.messages.length),console.log("ðŸ” STT Stream messages:",o.messages.filter(f=>f.kind==="STT Stream").length),console.log("ðŸ” Transcription messages:",o.messages.filter(f=>f.kind==="Transcription").length);let s=o.messages.find(f=>f.id===g);if(console.log("ðŸ” STT message for transcript:",s==null?void 0:s.id,s==null?void 0:s.conversation_session_id),!s){console.log("ðŸ“ No STT Stream message found for ID:",g,"scanning for existing STT conversations");const f=o.messages.filter(p=>p.kind==="STT Stream"||p.kind==="Transcription"||p.kind==="STT File"&&p.isTranscription);if(console.log("ðŸ” Found",f.length,"STT-related messages in conversation"),f.length>0){const p=f.sort((de,ue)=>ue.createdAt-de.createdAt)[0],I=p.conversation_session_id;console.log("âœ… Found existing STT conversation:",I,"from message:",p.id);const N={id:`stt_stream_${Date.now()}`,role:"user",content:"ðŸŽ¤ Recording...",createdAt:Date.now(),sessionId:n.currentSessionId||void 0,conversation_session_id:I,kind:"STT Stream",status:"done",isRecording:!1};console.log("âœ… Creating new STT Stream message linked to existing conversation:",N.id,"with conversation_session_id:",I);const q=[...o.messages,N];console.log("ðŸ“‹ Updated conversation with linked STT Stream message, total messages:",q.length),g=N.id,s=N;const le={...o,messages:q};return console.log("âœ… Using newly created STT Stream message linked to existing conversation"),le}else{console.log("ðŸ“ No existing STT conversations found, creating completely new conversation");const p=`transcript_session_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,I={id:`stt_stream_${Date.now()}`,role:"user",content:"ðŸŽ¤ Recording...",createdAt:Date.now(),sessionId:n.currentSessionId||void 0,conversation_session_id:p,kind:"STT Stream",status:"done",isRecording:!1};console.log("âœ… Creating new STT Stream message with new conversation:",I.id,"with conversation_session_id:",p);const N=[...o.messages,I];console.log("ðŸ“‹ Updated conversation with new STT Stream message, total messages:",N.length),g=I.id,s=I;const q={...o,messages:N};return console.log("âœ… Using newly created STT Stream message with new conversation"),q}}if(!s.conversation_session_id)return console.warn("âš ï¸ STT Stream message missing conversation_session_id"),o;const w=s.conversation_session_id;L.current.has(w)||L.current.set(w,new Set);const a=L.current.get(w);if(a.has(e.transcript))return console.log("ðŸ”„ Skipping duplicate transcript:",e.transcript,"for conversation:",w),o;a.add(e.transcript),console.log("âœ… Processing transcript:",e.transcript,"for conversation:",w);const h=o.messages.filter(f=>f.kind==="Transcription"&&f.conversation_session_id===s.conversation_session_id);console.log("ðŸ” Found",h.length,"existing transcription messages with conversation_session_id:",s.conversation_session_id);const R=h.length>0?h.sort((f,p)=>p.createdAt-f.createdAt)[0]:null;if(console.log("ðŸ” Most recent transcription message:",R==null?void 0:R.id,((Y=R==null?void 0:R.content)==null?void 0:Y.substring(0,100))+"..."),R){const f=o.messages.map(p=>{if(p.id===R.id){const I=p.content?`${p.content} ${e.transcript}`:e.transcript;return console.log("âœ… Appending transcript to existing transcription:",e.transcript,"conversation_session_id:",s==null?void 0:s.conversation_session_id),console.log("âœ… Old content:",p.content,"â†’ New content:",I),{...p,content:I,createdAt:Date.now()}}return p});return{...o,messages:f}}else{const f={id:`transcript_${Date.now()}`,role:"assistant",content:e.transcript,createdAt:Date.now(),sessionId:n.currentSessionId||void 0,conversation_session_id:s.conversation_session_id,kind:"Transcription",status:"done",isTranscription:!0};return console.log("âœ… Creating new transcription message:",e.transcript,"with conversation_session_id:",s.conversation_session_id),console.log("ðŸ“‹ Total messages before adding new transcription:",o.messages.length),{...o,messages:[...o.messages,f]}}})}),i.on("structured",e=>{if(console.log("ðŸ”§ Structured event received:",e),console.log("ðŸ“Š Structured results:",e.results),!e.results||typeof e.results!="object"){console.warn("âš ï¸ No structured results to process");return}const g=l.current;if(!g){console.warn("âš ï¸ No current STT message ID for structured data");return}v(o=>{const s=o.messages.find(a=>a.id===g);if(!s)return console.warn("âš ï¸ Could not find current STT message"),o;const w=o.messages.find(a=>a.kind==="Structured"&&a.conversation_session_id===s.conversation_session_id);if(w){const a=o.messages.map(h=>h.id===w.id?(console.log("âœ… Updating existing structured message with new data"),{...h,structuredData:{...h.structuredData,...e.results},content:`Structured data updated (${Object.keys(e.results).length} fields)`}):h);return{...o,messages:a}}else{const a={id:`structured_${Date.now()}`,role:"assistant",content:`Structured data received (${Object.keys(e.results).length} fields)`,createdAt:Date.now(),sessionId:n.currentSessionId||void 0,conversation_session_id:s.conversation_session_id,kind:"Structured",status:"done",structuredData:e.results};return console.log("âœ… Creating new structured message:",{id:a.id,conversation_session_id:a.conversation_session_id,resultsCount:Object.keys(e.results).length}),{...o,messages:[...o.messages,a]}}})}),i.on("error",e=>{console.error("âŒ Connection Error:",e),k.error(`Error: ${(e==null?void 0:e.message)||"Connection failed"}`),console.log("âŒ Setting error status for message:",l.current),l.current&&v(g=>{const o=g.messages.map(s=>s.id===l.current?(console.log("âœ… Setting error status for message:",s.id),{...s,status:"error",content:"ðŸŽ¤ Recording failed",error:(e==null?void 0:e.message)||"Connection failed",isRecording:!1}):(s.isRecording&&console.log("âŒ Clearing isRecording for message:",s.id),{...s,isRecording:!1}));return D(o,"Recording Error"),{...g,messages:o}}),l.current=null,u(g=>({...g,currentRecordingMessageId:void 0})),J()}),i.on("disconnect",e=>{console.log("ðŸ”Œ Disconnected:",e),e&&e!=="io client disconnect"&&k.error(`Disconnected: ${e}`),S.current&&(clearInterval(S.current),S.current=null)})),$.current=i,console.log("âœ… STT stream created and handlers set up"),i.connected?(console.log("ðŸ”Œ Reusing existing STT connection..."),setTimeout(async()=>{try{await z(i)}catch(e){console.error("âŒ Error setting up audio pipeline for existing connection:",e)}},0)):(console.log("ðŸ”Œ Connection was closed, creating new STT stream..."),i.connect())}catch(t){console.error("âŒ Error starting recording:",t);let r="Failed to start recording";t instanceof Error&&(t.name==="NotAllowedError"?r="Microphone access denied. Please allow microphone permissions.":t.name==="NotFoundError"?r="No microphone found. Please connect a microphone and try again.":t.name==="NotReadableError"?r="Microphone is already in use by another application.":t.name==="OverconstrainedError"?r="Microphone doesn't support the required audio format.":r=t.message),k.error(r),P(),console.log("âŒ Setting error status for message (startRecording):",l.current),l.current&&v(d=>{const c=d.messages.map(i=>i.id===l.current?(console.log("âœ… Setting error status for message:",i.id),{...i,status:"error",content:"ðŸŽ¤ Recording failed",error:r,isRecording:!1}):(i.isRecording&&console.log("âŒ Clearing isRecording for message:",i.id),{...i,isRecording:!1}));return D(c,"Recording Error (Start)"),{...d,messages:c}}),l.current=null,u(d=>({...d,sttRequestStartedAtMs:0,sttRequestElapsedMs:0,currentRecordingMessageId:void 0})),T.current=0}},J=()=>{if(console.log("ðŸ”´ Stopping recording for message:",l.current),l.current){const r=T.current>0?Date.now()-T.current:0;console.log("ðŸ“ Setting message to done status:",l.current,"duration:",r),v(d=>{const c=d.messages.map(i=>i.id===l.current?(console.log("âœ… Setting done status for message:",i.id),{...i,status:"done",durationMs:r,isRecording:!1}):(i.isRecording&&console.log("âŒ Clearing isRecording for message:",i.id),{...i,isRecording:!1}));return D(c,"Recording Completed"),{...d,messages:c}})}V({isStreaming:!1}),$.current&&!S.current&&(S.current=setInterval(()=>{if($.current&&$.current.connected)try{$.current.send(new ArrayBuffer(0))}catch(r){console.log("Keepalive ping failed:",r),S.current&&(clearInterval(S.current),S.current=null)}},3e4)),P();const t=l.current;l.current=null,console.log("ðŸ§¹ Clearing current recording message ID:",t),u(r=>({...r,isRecording:!1,partialText:"",currentRecordingMessageId:void 0,sttRequestStartedAtMs:0,sttRequestElapsedMs:0})),console.log("ðŸ”´ Recording stopped, microphone in ready state",{isRecording:!1,microphoneState:"ready",currentSessionId:n.currentSessionId,previousMessageId:t,micAllowed:!0}),T.current=0},re=async()=>{if(console.log("ðŸŽ¤ Microphone button clicked",{computedState:y,audioState:n.microphoneState,isConnected:A,sessionId:n.currentSessionId,isRecording:n.isRecording}),y==="connected"){console.log("ðŸ”´ Currently connected/recording, stopping..."),J();return}if(y==="ready"){console.log("ðŸŽ¤ In ready state, starting recording..."),await X();return}if(!x){console.log("ðŸŽ¤ No session exists, creating session..."),U(!0);try{await ie()}catch(t){console.error("âŒ Error creating session:",t),U(!1)}return}},ie=async()=>{try{console.log("ðŸ”§ Creating new session for microphone recording..."),await se(),console.log("âœ… Session created successfully:",x),await X()}catch(t){console.error("âŒ Failed to create session:",t),k.error("Failed to create session. Please check your API key in the settings and try again â†’"),U(!1)}},ce=()=>{const t=Re(j.stt.language);switch(G){case"connecting":return m.jsxs("div",{className:"voice-controls__mic-container",children:[m.jsx("div",{className:"voice-controls__connecting-indicator",children:m.jsx("div",{className:"voice-controls__connecting-dot"})}),m.jsx(ee,{className:"voice-controls__mic-icon--connecting"}),m.jsx("div",{className:"voice-controls__language-indicator",children:t})]});case"connected":return m.jsxs("div",{className:"voice-controls__mic-container",children:[m.jsx(Te,{className:"voice-controls__mic-icon--connected"}),m.jsx("div",{className:"voice-controls__language-indicator",children:t})]});case"ready":return m.jsxs("div",{className:"voice-controls__mic-container",children:[m.jsx(ne,{className:"voice-controls__mic-icon--ready"}),m.jsx("div",{className:"voice-controls__language-indicator",children:t})]});case"preparingMic":return m.jsxs("div",{className:"voice-controls__mic-container",children:[m.jsx("div",{className:"voice-controls__connecting-indicator",children:m.jsx("div",{className:"voice-controls__connecting-dot--white"})}),m.jsx(ne,{className:"voice-controls__mic-icon--preparing"}),m.jsx("div",{className:"voice-controls__language-indicator",children:t})]});default:return m.jsxs("div",{className:"voice-controls__mic-container",children:[m.jsx(ee,{className:"voice-controls__mic-icon--idle"}),m.jsx("div",{className:"voice-controls__language-indicator",children:t})]})}},ae=()=>{console.log("ðŸ” getButtonClassName-> Getting button class name for state:",G);const t="voice-controls__mic-button",r=(()=>{switch(G){case"connected":return"voice-controls__mic-button--connected";case"ready":return"voice-controls__mic-button--ready";case"connecting":return"voice-controls__mic-button--connecting";case"preparingMic":return"voice-controls__mic-button--preparingMic";default:return"voice-controls__mic-button--idle"}})();return`${t} ${r}`};return m.jsx("div",{className:fe("VoiceControls","voice-controls-buttons"),children:m.jsx(Se,{variant:"ghost",size:"sm",onClick:re,disabled:H,className:`voice-controls__mic-button ${ae()}`,children:ce()})})}export{Ee as VoiceControls};
