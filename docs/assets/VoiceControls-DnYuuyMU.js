import{j as u}from"./ui-DXEsCjYO.js";import{r as f}from"./vendor-B6OAZll8.js";import{b as O}from"./state-BMzes8HB.js";import{b as se,d as re,s as ce,c as ie,B as ae}from"./index-urjlV3O_.js";import{u as le}from"./useConnection-BggP5CuE.js";import{u as ue}from"./useSTT-Cz6c9byl.js";import{t as y}from"./utils-E4Pq5uL6.js";import{f as W,g as Z,h as de}from"./icons-0o0JEzD5.js";import"./sdk-9Bd1H_oq.js";function ge(n){const l=n.environment;return{apiKey:n[l].connection.apiKey,baseUrl:n[l].connection.baseUrl,authBaseUrl:n[l].connection.authBaseUrl,workflowId:n[l].connection.workflowId,environment:l,stt:n[l].stt,tts:n[l].tts}}const pe=[{value:"en_US",label:"English (US)",shortLabel:"EN"},{value:"en_GB",label:"English (UK)",shortLabel:"EN"},{value:"es_ES",label:"Spanish (Spain)",shortLabel:"ES"},{value:"fr_FR",label:"French (France)",shortLabel:"FR"},{value:"de_DE",label:"German (Germany)",shortLabel:"DE"},{value:"it_IT",label:"Italian (Italy)",shortLabel:"IT"},{value:"pt_BR",label:"Portuguese (Brazil)",shortLabel:"PT"},{value:"ja_JP",label:"Japanese (Japan)",shortLabel:"JA"},{value:"ko_KR",label:"Korean (Korea)",shortLabel:"KO"},{value:"zh_CN",label:"Chinese (China)",shortLabel:"ZH"}],me=n=>{const l=pe.find(h=>h.value===n);return(l==null?void 0:l.shortLabel)||n},k=(n,l="Conversation Update")=>{console.group(`ðŸ“‹ ${l}`),console.log(`Total messages: ${n.length}`);const h=n.filter(_=>_.kind==="STT Stream"),I=n.filter(_=>_.isRecording===!0);console.log(`STT messages: ${h.length}`),console.log(`Currently recording: ${I.length}`),n.forEach((_,c)=>{const U=_.isRecording?"ðŸ”´":"âšª",P=_.status||"unknown",b=_.kind||"unknown",M=_.durationMs?`${(_.durationMs/1e3).toFixed(1)}s`:"0s";console.log(`${c+1}. ${U} [${b}] ${_.id.substring(0,20)}... | ${P} | ${M}`)}),I.length>0&&console.log("ðŸŽ¤ Currently recording:",I[0].id),console.groupEnd()};function ye(){const[n,l]=O(se),[,h]=O(re),[I]=O(ce),_=ge(I),c=f.useRef(null),{createStreamConnection:U,closeStream:P}=ue(),{isConnected:b,sessionId:M,createSession:Q,isConnecting:A,isOnline:X,updateConnectionState:G}=le(),[q,$]=f.useState(!1),[Y,z]=f.useState(!1),w=n.isRecording?"connected":Y?"preparingMic":A||q?"connecting":X&&M?"ready":"idle";f.useEffect(()=>{if(q){const t=setTimeout(()=>{$(!1)},3e3);return()=>clearTimeout(t)}},[q]);const F=w;f.useEffect(()=>{console.log("ðŸ” VoiceControls state:",{computedMicrophoneState:w,isConnecting:A,isConnected:b,sessionId:M,audioState:n.microphoneState})},[w,A,b,M,n.microphoneState]),f.useEffect(()=>{if(console.log("ðŸ” Sync effect triggered:",{audioState:n.microphoneState,computedState:w,isRecording:n.isRecording,shouldSync:n.microphoneState!==w}),n.microphoneState!==w){console.log("ðŸ”„ Syncing audio state with computed state:",{from:n.microphoneState,to:w});const t=M||n.currentSessionId;l(o=>({...o,microphoneState:w,currentSessionId:t}))}},[w,n.microphoneState,n.currentSessionId,n.isRecording,M,l]);const T=f.useRef(null),j=f.useRef(null),N=f.useRef(null),x=f.useRef(null),S=f.useRef(0),p=f.useRef(null),D=f.useRef(new Map),J=f.useRef(new Set);f.useEffect(()=>{if(S.current===0||!n.isRecording)return;const t=setInterval(()=>{const o=Date.now();l(i=>{const s=S.current>0?o-S.current:0;return s>0&&s%1e3<100&&console.log(`Timer running: ${s}ms`),{...i,elapsedMs:i.startedAtMs>0?o-i.startedAtMs:0,sttRequestElapsedMs:s}}),c.current&&S.current>0&&(console.log("ðŸ”„ Updating conversation message duration:",{currentMessageId:c.current,sttStartTime:S.current,elapsed:o-S.current}),h(i=>({...i,messages:i.messages.map(s=>s.id===c.current?(console.log("ðŸ“ Updating STT message:",s.id,"duration:",o-S.current),{...s,durationMs:o-S.current}):s)})))},100);return()=>clearInterval(t)},[n.isRecording,n.startedAtMs,n.sttRequestStartedAtMs,n.currentSessionId,l,h,S]),f.useEffect(()=>()=>{p.current&&(clearInterval(p.current),p.current=null),P(),L()},[]);const L=()=>{N.current&&(N.current.getTracks().forEach(t=>t.stop()),N.current=null),T.current&&T.current.state!=="closed"&&(T.current.close(),T.current=null),j.current=null},B=async t=>{console.log("ðŸŽµ Setting up audio pipeline..."),G({isStreaming:!0,error:void 0}),p.current&&(clearInterval(p.current),p.current=null),console.log("ðŸ”„ Updating message status to streaming for:",c.current),h(o=>{const i=o.messages.map(s=>s.id===c.current?(console.log("âœ… Setting streaming status for message:",s.id),{...s,status:"streaming",content:"ðŸŽ¤ Recording... (Streaming)",isRecording:!0}):(s.isRecording&&console.log("âŒ Clearing isRecording for non-current message:",s.id),{...s,isRecording:!1}));return k(i,"Message Status Updated to Streaming"),{...o,messages:i}});try{const o=T.current.createMediaStreamSource(N.current);j.current=new AudioWorkletNode(T.current,"audio-processor");let i=0;j.current.port.onmessage=s=>{try{t.send(s.data.audio_data),i++,i%50===0&&console.log(`ðŸ”Š Sent ${i} audio packets`)}catch(r){i%100===0&&console.error("âš ï¸ Error sending audio data:",r)}},o.connect(j.current),console.log("âœ… Audio pipeline connected"),l(s=>(console.log("ðŸŽ¯ Setting isRecording to true, current state:",{isRecording:s.isRecording,microphoneState:s.microphoneState}),{...s,micAllowed:!0,isRecording:!0,startedAtMs:Date.now(),elapsedMs:0})),z(!1),console.log("âœ… Recording started successfully",{isRecording:!0,currentSessionId:n.currentSessionId,micAllowed:!0})}catch(o){throw console.error("âŒ Error setting up audio pipeline:",o),y.error("Failed to set up audio"),p.current&&(clearInterval(p.current),p.current=null),o}},H=async()=>{if(console.log("ðŸŽ¤ Starting recording..."),!_.apiKey){y.error("Please configure your API key first");return}try{const t=`stt_request_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o=`recording_${n.currentSessionId||"default"}_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,i={id:t,role:"user",content:"ðŸŽ¤ Recording...",createdAt:Date.now(),sessionId:n.currentSessionId||void 0,conversation_session_id:o,kind:"STT Stream",status:"recording",isRecording:!0};console.log("ðŸŽ¤ Creating new STT message:",t,"with isRecording: true"),c.current=t,D.current.delete(t),l(e=>({...e,currentRecordingMessageId:t})),h(e=>{const m=[...e.messages.map(a=>({...a,isRecording:!1})),i];return k(m,"New STT Message Created"),{...e,messages:m}}),S.current=Date.now(),console.log("ðŸ’¬ Added STT request message to chat:",i.id,"Timer started at:",S.current),z(!0),console.log("ðŸŽ¤ Step 1: Accessing microphone stream...");const s=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}});console.log("âœ… Microphone stream accessed"),N.current=s,console.log("ðŸŽ¤ Step 2: Setting up AudioContext...");try{T.current=new AudioContext({sampleRate:16e3,latencyHint:"interactive"}),T.current.state==="suspended"&&await T.current.resume(),await T.current.audioWorklet.addModule("/aiola-voice-api-app/audio-processor.js"),console.log("âœ… Audio worklet loaded"),console.log("ðŸ”§ Microphone preparation phase started")}catch(e){console.error("âŒ AudioContext setup failed:",e),y.error("Failed to initialize audio system. Please check your browser settings."),L();return}console.log("ðŸ“¡ Step 3: Creating STT stream...");const r=await U();J.current.has(r)?(console.log("ðŸ”„ Reusing existing connection handlers"),r.connected&&(console.log("ðŸ”Œ Connection already connected, setting up audio pipeline..."),setTimeout(async()=>{try{await B(r)}catch(e){console.error("âŒ Error setting up audio pipeline for existing connection:",e)}},0))):(console.log("ðŸ”§ Setting up new connection handlers"),J.current.add(r),r.on("connect",async()=>{console.log("âœ… Stream connected - Setting up audio pipeline..."),y.success("Connected - Recording started");try{await B(r)}catch(e){console.error("âŒ Error in connect handler:",e),K()}}),r.on("transcript",e=>{console.log("test-x New transcript arriving from SDK:",e.transcript),console.log("ðŸ“ Transcript received:",e.transcript),console.log("ðŸ” Current recording message ID:",c.current);const R=c.current;if(!R){console.warn("âš ï¸ No current STT message ID, skipping transcript processing");return}D.current.has(R)||D.current.set(R,new Set);const m=D.current.get(R);if(m.has(e.transcript)){console.log("ðŸ”„ Skipping duplicate transcript:",e.transcript);return}m.add(e.transcript),console.log("âœ… Processing new transcript:",e.transcript),h(a=>{var C;console.log("ðŸ” Total messages:",a.messages.length),console.log("ðŸ” STT Stream messages:",a.messages.filter(v=>v.kind==="STT Stream").length),console.log("ðŸ” Transcription messages:",a.messages.filter(v=>v.kind==="Transcription").length);const g=a.messages.find(v=>v.id===c.current);if(console.log("ðŸ” Current STT message:",g==null?void 0:g.id,g==null?void 0:g.conversation_session_id),!g||!g.conversation_session_id)return console.warn("âš ï¸ No current STT Stream message found or missing conversation_session_id"),a;const d=a.messages.find(v=>v.kind==="Transcription"&&v.conversation_session_id===g.conversation_session_id&&v.role==="assistant");if(console.log("ðŸ” Existing transcription message:",d==null?void 0:d.id,((C=d==null?void 0:d.content)==null?void 0:C.substring(0,100))+"..."),console.log("ðŸ” Looking for transcription message with conversation_session_id:",g.conversation_session_id),d){const v=a.messages.map(E=>{if(E.id===d.id){const V=E.content?`${E.content} ${e.transcript}`:e.transcript;return console.log("test-x Agent STT response updated:",e.transcript,"conversation_session_id:",g==null?void 0:g.conversation_session_id),console.log("âœ… Updating existing transcription message:",e.transcript,"â†’ New content:",V),{...E,content:V,createdAt:Date.now()}}return E});return{...a,messages:v}}else{const v={id:`transcript_${Date.now()}`,role:"assistant",content:e.transcript,createdAt:Date.now(),sessionId:n.currentSessionId||void 0,conversation_session_id:g.conversation_session_id,kind:"Transcription",status:"done",isTranscription:!0};return console.log("test-x New agent STT response created:",e.transcript),console.log("âœ… Creating new transcription message:",e.transcript,"with conversation_session_id:",g.conversation_session_id),console.log("ðŸ“‹ Total messages before adding new transcription:",a.messages.length),{...a,messages:[...a.messages,v]}}})}),r.on("structured",e=>{if(console.log("ðŸ”§ Structured event received:",e),console.log("ðŸ“Š Structured results:",e.results),!e.results||typeof e.results!="object"){console.warn("âš ï¸ No structured results to process");return}const R=c.current;if(!R){console.warn("âš ï¸ No current STT message ID for structured data");return}h(m=>{const a=m.messages.find(d=>d.id===R);if(!a)return console.warn("âš ï¸ Could not find current STT message"),m;const g=m.messages.find(d=>d.kind==="Structured"&&d.conversation_session_id===a.conversation_session_id);if(g){const d=m.messages.map(C=>C.id===g.id?(console.log("âœ… Updating existing structured message with new data"),{...C,structuredData:{...C.structuredData,...e.results},content:`Structured data updated (${Object.keys(e.results).length} fields)`}):C);return{...m,messages:d}}else{const d={id:`structured_${Date.now()}`,role:"assistant",content:`Structured data received (${Object.keys(e.results).length} fields)`,createdAt:Date.now(),sessionId:n.currentSessionId||void 0,conversation_session_id:a.conversation_session_id,kind:"Structured",status:"done",structuredData:e.results};return console.log("âœ… Creating new structured message:",{id:d.id,conversation_session_id:d.conversation_session_id,resultsCount:Object.keys(e.results).length}),{...m,messages:[...m.messages,d]}}})}),r.on("error",e=>{console.error("âŒ Connection Error:",e),y.error(`Error: ${(e==null?void 0:e.message)||"Connection failed"}`),console.log("âŒ Setting error status for message:",c.current),c.current&&h(R=>{const m=R.messages.map(a=>a.id===c.current?(console.log("âœ… Setting error status for message:",a.id),{...a,status:"error",content:"ðŸŽ¤ Recording failed",error:(e==null?void 0:e.message)||"Connection failed",isRecording:!1}):(a.isRecording&&console.log("âŒ Clearing isRecording for message:",a.id),{...a,isRecording:!1}));return k(m,"Recording Error"),{...R,messages:m}}),c.current=null,l(R=>({...R,currentRecordingMessageId:void 0})),K()}),r.on("disconnect",e=>{console.log("ðŸ”Œ Disconnected:",e),e&&e!=="io client disconnect"&&y.error(`Disconnected: ${e}`),p.current&&(clearInterval(p.current),p.current=null)})),x.current=r,console.log("âœ… STT stream created and handlers set up"),r.connected?(console.log("ðŸ”Œ Reusing existing STT connection..."),setTimeout(async()=>{try{await B(r)}catch(e){console.error("âŒ Error setting up audio pipeline for existing connection:",e)}},0)):(console.log("ðŸ”Œ Connection was closed, creating new STT stream..."),r.connect())}catch(t){console.error("âŒ Error starting recording:",t);let o="Failed to start recording";t instanceof Error&&(t.name==="NotAllowedError"?o="Microphone access denied. Please allow microphone permissions.":t.name==="NotFoundError"?o="No microphone found. Please connect a microphone and try again.":t.name==="NotReadableError"?o="Microphone is already in use by another application.":t.name==="OverconstrainedError"?o="Microphone doesn't support the required audio format.":o=t.message),y.error(o),L(),console.log("âŒ Setting error status for message (startRecording):",c.current),c.current&&h(i=>{const s=i.messages.map(r=>r.id===c.current?(console.log("âœ… Setting error status for message:",r.id),{...r,status:"error",content:"ðŸŽ¤ Recording failed",error:o,isRecording:!1}):(r.isRecording&&console.log("âŒ Clearing isRecording for message:",r.id),{...r,isRecording:!1}));return k(s,"Recording Error (Start)"),{...i,messages:s}}),c.current=null,l(i=>({...i,sttRequestStartedAtMs:0,sttRequestElapsedMs:0,currentRecordingMessageId:void 0})),S.current=0}},K=()=>{if(console.log("ðŸ”´ Stopping recording for message:",c.current),c.current){const o=S.current>0?Date.now()-S.current:0;console.log("ðŸ“ Setting message to done status:",c.current,"duration:",o),h(i=>{const s=i.messages.map(r=>r.id===c.current?(console.log("âœ… Setting done status for message:",r.id),{...r,status:"done",durationMs:o,isRecording:!1}):(r.isRecording&&console.log("âŒ Clearing isRecording for message:",r.id),{...r,isRecording:!1}));return k(s,"Recording Completed"),{...i,messages:s}})}G({isStreaming:!1}),x.current&&!p.current&&(p.current=setInterval(()=>{if(x.current&&x.current.connected)try{x.current.send(new ArrayBuffer(0))}catch(o){console.log("Keepalive ping failed:",o),p.current&&(clearInterval(p.current),p.current=null)}},3e4)),L();const t=c.current;c.current=null,console.log("ðŸ§¹ Clearing current recording message ID:",t),l(o=>({...o,isRecording:!1,partialText:"",currentRecordingMessageId:void 0,sttRequestStartedAtMs:0,sttRequestElapsedMs:0})),console.log("ðŸ”´ Recording stopped, microphone in ready state",{isRecording:!1,microphoneState:"ready",currentSessionId:n.currentSessionId,previousMessageId:t,micAllowed:!0}),S.current=0},ee=async()=>{if(console.log("ðŸŽ¤ Microphone button clicked",{computedState:w,audioState:n.microphoneState,isConnected:b,sessionId:n.currentSessionId,isRecording:n.isRecording}),w==="connected"){console.log("ðŸ”´ Currently connected/recording, stopping..."),K();return}if(w==="ready"){console.log("ðŸŽ¤ In ready state, starting recording..."),await H();return}if(!M){console.log("ðŸŽ¤ No session exists, creating session..."),$(!0);try{await ne()}catch(t){console.error("âŒ Error creating session:",t),$(!1)}return}},ne=async()=>{try{console.log("ðŸ”§ Creating new session for microphone recording..."),await Q(),console.log("âœ… Session created successfully:",M),await H()}catch(t){console.error("âŒ Failed to create session:",t),y.error("Failed to create session. Please check your API key in the settings and try again â†’"),$(!1)}},te=()=>{const t=me(_.stt.language);switch(F){case"connecting":return u.jsxs("div",{className:"voice-controls__mic-container",children:[u.jsx("div",{className:"voice-controls__connecting-indicator",children:u.jsx("div",{className:"voice-controls__connecting-dot"})}),u.jsx(W,{className:"voice-controls__mic-icon--connecting"}),u.jsx("div",{className:"voice-controls__language-indicator",children:t})]});case"connected":return u.jsxs("div",{className:"voice-controls__mic-container",children:[u.jsx(de,{className:"voice-controls__mic-icon--connected"}),u.jsx("div",{className:"voice-controls__language-indicator",children:t})]});case"ready":return u.jsxs("div",{className:"voice-controls__mic-container",children:[u.jsx(Z,{className:"voice-controls__mic-icon--ready"}),u.jsx("div",{className:"voice-controls__language-indicator",children:t})]});case"preparingMic":return u.jsxs("div",{className:"voice-controls__mic-container",children:[u.jsx("div",{className:"voice-controls__connecting-indicator",children:u.jsx("div",{className:"voice-controls__connecting-dot--white"})}),u.jsx(Z,{className:"voice-controls__mic-icon--preparing"}),u.jsx("div",{className:"voice-controls__language-indicator",children:t})]});default:return u.jsxs("div",{className:"voice-controls__mic-container",children:[u.jsx(W,{className:"voice-controls__mic-icon--idle"}),u.jsx("div",{className:"voice-controls__language-indicator",children:t})]})}},oe=()=>{console.log("ðŸ” getButtonClassName-> Getting button class name for state:",F);const t="voice-controls__mic-button",o=(()=>{switch(F){case"connected":return"voice-controls__mic-button--connected";case"ready":return"voice-controls__mic-button--ready";case"connecting":return"voice-controls__mic-button--connecting";case"preparingMic":return"voice-controls__mic-button--preparingMic";default:return"voice-controls__mic-button--idle"}})();return`${t} ${o}`};return u.jsx("div",{className:ie("VoiceControls","voice-controls-buttons"),children:u.jsx(ae,{variant:"ghost",size:"sm",onClick:ee,disabled:A,className:`voice-controls__mic-button ${oe()}`,children:te()})})}export{ye as VoiceControls};
